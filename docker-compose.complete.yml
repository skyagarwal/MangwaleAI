
# =============================================================
# MangwaleAI Complete Development Stack
# =============================================================
# This file starts ALL services needed for full development
# Includes: Backend, Frontend, LLM (vLLM), NLU, Databases, Monitoring
# 
# Usage: 
#   Start all:     docker-compose -f docker-compose.complete.yml up -d
#   Start no GPU:  docker-compose -f docker-compose.complete.yml up -d --scale vllm=0 --scale nlu=0
#   Logs:          docker-compose -f docker-compose.complete.yml logs -f
#   Stop:          docker-compose -f docker-compose.complete.yml down
# =============================================================

services:
  # ===========================================
  # DATABASE SERVICES
  # ===========================================
  
  postgres:
    image: postgres:15-alpine
    container_name: mangwale_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: mangwale_config
      POSTGRES_PASSWORD: config_secure_pass_2024
      POSTGRES_DB: headless_mangwale
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mangwale-network
      - search_search-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mangwale_config -d headless_mangwale"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: mangwale_redis
    restart: unless-stopped
    ports:
      - "6381:6379"
    volumes:
      - redis-data:/data
    networks:
      - mangwale-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # BACKEND SERVICE (NestJS) - Development Mode
  # ===========================================
  
  backend:
    image: node:20-bookworm-slim
    container_name: mangwale_backend
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y openssl curl procps && npm install && npm run start:dev"
    ports:
      - "3200:3200"
    volumes:
      - ./backend:/app
      - backend-node-modules:/app/node_modules
      - ./backend/logs:/app/logs
    environment:
      NODE_ENV: development
      PORT: 3200
      TZ: Asia/Kolkata
      
      # Database
      DATABASE_URL: postgresql://mangwale_config:config_secure_pass_2024@postgres:5432/headless_mangwale?schema=public
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 1
      
      # AI Services - LLM
      VLLM_URL: http://vllm:8000
      VLLM_MODEL: Qwen/Qwen2.5-7B-Instruct-AWQ
      LLM_MODE: hybrid
      DEFAULT_LLM_PROVIDER: vllm
      
      # AI Services - NLU (Mercury GPU Server - set in .env)
      NLU_PRIMARY_ENDPOINT: ${NLU_PRIMARY_ENDPOINT}
      NER_SERVICE_URL: ${NER_SERVICE_URL}
      NLU_CONFIDENCE_THRESHOLD: ${NLU_CONFIDENCE_THRESHOLD:-0.65}
      NLU_AI_ENABLED: "true"
      
      # Groq Fallback (when vLLM unavailable)
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      
      # PHP Backend
      PHP_API_BASE_URL: https://new.mangwale.com
      PHP_BACKEND_URL: https://new.mangwale.com
      
      # MySQL Database (Laravel Backend - set in .env)
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mangwale_db}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      
      # OpenSearch
      OPENSEARCH_URL: http://search-opensearch:9200
      OPENSEARCH_USERNAME: admin
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD:-admin}
      
      # Search API
      SEARCH_API_URL: http://search-api:3100
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-mangwale-secure-jwt-secret-2024}
      
      # Session
      SESSION_TTL: 86400
      OTP_TTL: 600
      OTP_LENGTH: 6
      
      # Logging
      LOG_LEVEL: debug
      
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - mangwale-network
      - search_search-network
      - traefik-public
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=search_search-network"
      
      # API Routes
      - "traefik.http.routers.mangwale-api.rule=Host(`api.mangwale.ai`)"
      - "traefik.http.routers.mangwale-api.entrypoints=websecure"
      - "traefik.http.routers.mangwale-api.tls=true"
      - "traefik.http.routers.mangwale-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.mangwale-api.service=mangwale-backend"
      
      # WebSocket Routes
      - "traefik.http.routers.mangwale-ws.rule=Host(`api.mangwale.ai`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.mangwale-ws.entrypoints=websecure"
      - "traefik.http.routers.mangwale-ws.tls=true"
      - "traefik.http.routers.mangwale-ws.service=mangwale-backend"
      - "traefik.http.routers.mangwale-ws.priority=100"
      - "traefik.http.routers.mangwale-ws.middlewares=websocket-headers@file"
      
      # Chat domain WebSocket routes
      - "traefik.http.routers.chat-ws.rule=Host(`chat.mangwale.ai`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.chat-ws.entrypoints=websecure"
      - "traefik.http.routers.chat-ws.tls=true"
      - "traefik.http.routers.chat-ws.service=mangwale-backend"
      - "traefik.http.routers.chat-ws.priority=100"
      - "traefik.http.routers.chat-ws.middlewares=websocket-headers@file"
      
      # Chat domain API routes (for /api/* paths)
      - "traefik.http.routers.chat-api.rule=Host(`chat.mangwale.ai`) && PathPrefix(`/api`)"
      - "traefik.http.routers.chat-api.entrypoints=websecure"
      - "traefik.http.routers.chat-api.tls=true"
      - "traefik.http.routers.chat-api.service=mangwale-backend"
      - "traefik.http.routers.chat-api.priority=50"
      
      # DEDICATED WebSocket subdomain (ws.mangwale.ai) - Industry standard approach
      # All WebSocket connections go here directly, no path prefix needed
      - "traefik.http.routers.ws-dedicated.rule=Host(`ws.mangwale.ai`)"
      - "traefik.http.routers.ws-dedicated.entrypoints=websecure"
      - "traefik.http.routers.ws-dedicated.tls=true"
      - "traefik.http.routers.ws-dedicated.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ws-dedicated.service=mangwale-backend"
      - "traefik.http.routers.ws-dedicated.middlewares=websocket-headers@file"
      
      # Service definition
      - "traefik.http.services.mangwale-backend.loadbalancer.server.port=3200"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3200/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================
  # FRONTEND SERVICE (Next.js) - Development Mode
  # ===========================================
  
  frontend:
    image: node:20-alpine
    container_name: mangwale_frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    ports:
      - "3005:3005"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
      WATCHPACK_POLLING: "true"
      
      # Backend URLs
      NEXT_PUBLIC_WS_URL: ws://localhost:3200
      NEXT_PUBLIC_MANGWALE_AI_URL: http://localhost:3200
      NEXT_PUBLIC_ADMIN_BACKEND_URL: http://localhost:3200
      # Use mangwale_dev_backend when running with dev compose, or mangwale_backend with complete compose
      BACKEND_INTERNAL_URL: http://mangwale_dev_backend:3200

      # Image-AI (Mangwale Eyes) - internal proxy target for /api/vision/*
      IMAGE_AI_URL: http://host.docker.internal:3000
      IMAGE_AI_INTERNAL_URL: http://host.docker.internal:3000
      
      # API Gateway
      NEXT_PUBLIC_API_URL: /api

    extra_hosts:
      - "host.docker.internal:host-gateway"
      
    networks:
      - mangwale-network
      - search_search-network
      - traefik-public
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=search_search-network"
      
      # Main domain
      - "traefik.http.routers.mangwale-frontend.rule=Host(`mangwale.ai`)"
      - "traefik.http.routers.mangwale-frontend.entrypoints=websecure"
      - "traefik.http.routers.mangwale-frontend.tls=true"
      - "traefik.http.routers.mangwale-frontend.service=mangwale-frontend"
      
      # Chat domain
      - "traefik.http.routers.chat-frontend.rule=Host(`chat.mangwale.ai`)"
      - "traefik.http.routers.chat-frontend.entrypoints=websecure"
      - "traefik.http.routers.chat-frontend.tls=true"
      - "traefik.http.routers.chat-frontend.service=mangwale-frontend"
      - "traefik.http.routers.chat-frontend.priority=1"
      
      # Admin domain
      - "traefik.http.routers.admin-frontend.rule=Host(`admin.mangwale.ai`)"
      - "traefik.http.routers.admin-frontend.entrypoints=websecure"
      - "traefik.http.routers.admin-frontend.tls=true"
      - "traefik.http.routers.admin-frontend.service=mangwale-frontend"
      - "traefik.http.routers.admin-frontend.priority=1"
      
      # Admin domain WebSocket routes
      - "traefik.http.routers.admin-ws.rule=Host(`admin.mangwale.ai`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.admin-ws.entrypoints=websecure"
      - "traefik.http.routers.admin-ws.tls=true"
      - "traefik.http.routers.admin-ws.service=mangwale-backend"
      - "traefik.http.routers.admin-ws.priority=100"
      
      # Service definition
      - "traefik.http.services.mangwale-frontend.loadbalancer.server.port=3005"

  # ===========================================
  # AI SERVICES - vLLM (Local LLM Inference)
  # ===========================================
  
  vllm:
    image: vllm/vllm-openai:v0.4.2
    container_name: mangwale_vllm
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "8002:8000"
    volumes:
      - ./backend/models/hub:/root/.cache/huggingface
    environment:
      HUGGING_FACE_HUB_TOKEN: ${HUGGING_FACE_HUB_TOKEN:-}
      NVIDIA_VISIBLE_DEVICES: all
    command: >
      --model Qwen/Qwen2.5-7B-Instruct-AWQ
      --max-model-len 4096
      --gpu-memory-utilization 0.7
      --trust-remote-code
      --host 0.0.0.0
      --port 8000
    networks:
      - mangwale-network
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\""]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s

  # ===========================================
  # AI SERVICES - NLU (Intent Classification)
  # ===========================================
  # NOTE: NLU runs on external server Mercury (192.168.0.151:7010)
  # Local NLU service commented out - use external instead
  #
  # nlu:
  #   image: admin-nlu:latest
  #   container_name: mangwale_nlu
  #   restart: unless-stopped
  #   runtime: nvidia
  #   ports:
  #     - "7010:7010"
  #   volumes:
  #     - ./backend/models:/models:ro
  #   environment:
  #     BASE_ENCODER: /models/indicbert_active
  #     INTENT_MODEL: /models/indicbert_active
  #     MODEL_PATH: /models/indicbert_active
  #     PORT: 7010
  #     NVIDIA_VISIBLE_DEVICES: all
  #   networks:
  #     - mangwale-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:7010/healthz"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 120s

  # ===========================================
  # MONITORING SERVICES
  # ===========================================
  
  # --- Traefik Reverse Proxy ---
  # NOTE: Traefik v2.10 is already running from Search stack on ports 80/443/8081
  # The existing Traefik handles all routing via docker labels
  # Shared networks: search_search-network, traefik-public
  # Dashboard: http://localhost:8081
  #
  # If you need a standalone Traefik for MangwaleAI only, uncomment below:
  # traefik:
  #   image: traefik:v3.0
  #   container_name: mangwale_traefik
  #   restart: unless-stopped
  #   command:
  #     - "--api.insecure=true"
  #     - "--api.dashboard=true"
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedbydefault=false"
  #     - "--providers.docker.network=mangwale-network"
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"
  #     - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
  #     - "--certificatesresolvers.letsencrypt.acme.email=devops@mangwale.ai"
  #     - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     - "8080:8080"
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - traefik-letsencrypt:/letsencrypt
  #   networks:
  #     - mangwale-network
  #     - search_search-network
  #     - traefik-public

  # --- Self-Heal (Autoheal) Container ---
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: mangwale_autoheal
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      AUTOHEAL_INTERVAL: 60
      AUTOHEAL_START_PERIOD: 300
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - mangwale-network

  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: mangwale_prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - mangwale-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:10.1.0
    container_name: mangwale_grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    networks:
      - mangwale-network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: mangwale_alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - mangwale-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # LOG AGGREGATION (Loki)
  # ===========================================
  loki:
    image: grafana/loki:2.9.0
    container_name: mangwale_loki
    restart: unless-stopped
    ports:
      - "3102:3102"
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - mangwale-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3102/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  node-exporter:
    image: prom/node-exporter:v1.6.1
    container_name: mangwale_node_exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - mangwale-network

# ===========================================
# NETWORKS
# ===========================================

networks:
  mangwale-network:
    driver: bridge
  search_search-network:
    external: true
  traefik-public:
    external: true

# ===========================================
# VOLUMES
# ===========================================

volumes:
  postgres-data:
  redis-data:
  backend-node-modules:
  frontend-node-modules:
  prometheus-data:
  grafana-data:
  alertmanager-data:
  loki-data:
  traefik-letsencrypt:
