# MinIO Object Storage - Production Deployment
# Deploy to: mangwalev1 (storage.mangwale.ai)
# 
# Usage:
#   docker compose up -d
#   docker compose logs -f
#
# Access:
#   API: http://localhost:9000 or https://storage.mangwale.ai
#   Console: http://localhost:9001

services:
  minio:
    image: minio/minio:latest
    container_name: mangwale_minio
    restart: unless-stopped
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
      MINIO_SERVER_URL: https://storage.mangwale.ai
      MINIO_BROWSER_REDIRECT_URL: https://console.storage.mangwale.ai
    volumes:
      - minio-data:/data
    networks:
      - minio-network
      - searchv2_search-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=searchv2_search-network"
      
      # MinIO API (S3 compatible)
      - "traefik.http.routers.minio-api.rule=Host(`storage.mangwale.ai`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls=true"
      - "traefik.http.routers.minio-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-api.service=minio-api-svc"
      - "traefik.http.services.minio-api-svc.loadbalancer.server.port=9000"
      
      # MinIO Console
      - "traefik.http.routers.minio-console.rule=Host(`console.storage.mangwale.ai`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls=true"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-console.service=minio-console-svc"
      - "traefik.http.services.minio-console-svc.loadbalancer.server.port=9001"

networks:
  minio-network:
    driver: bridge
  searchv2_search-network:
    external: true

volumes:
  minio-data:
    driver: local
