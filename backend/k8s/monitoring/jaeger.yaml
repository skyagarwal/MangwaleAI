# Jaeger Distributed Tracing for Mangwale
# Requires jaeger-operator to be installed
---
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: mangwale-jaeger
  namespace: mangwale
spec:
  strategy: production
  storage:
    type: elasticsearch
    options:
      es:
        server-urls: http://opensearch:9200
        index-prefix: jaeger
    secretName: jaeger-es-secret
  collector:
    replicas: 2
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
  query:
    replicas: 2
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
  agent:
    strategy: DaemonSet
---
# Secret for Jaeger to connect to OpenSearch
apiVersion: v1
kind: Secret
metadata:
  name: jaeger-es-secret
  namespace: mangwale
type: Opaque
data:
  ES_USERNAME: ""
  ES_PASSWORD: ""
---
# Service for Jaeger UI
apiVersion: v1
kind: Service
metadata:
  name: jaeger-query
  namespace: mangwale
spec:
  type: ClusterIP
  ports:
    - port: 16686
      targetPort: 16686
      name: http
  selector:
    app: jaeger
    app.kubernetes.io/component: query
---
# Ingress for Jaeger UI
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jaeger-ingress
  namespace: mangwale
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: internal-auth
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - tracing.internal.mangwale.ai
      secretName: tracing-tls
  rules:
    - host: tracing.internal.mangwale.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: jaeger-query
                port:
                  number: 16686
