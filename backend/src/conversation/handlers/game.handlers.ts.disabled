import { Logger } from '@nestjs/common';
import { SessionService } from '../../session/session.service';
import { MessagingService } from '../../messaging/services/messaging.service';
import { GameWidgetService } from '../../gamification/services/game-widget.service';
import { Platform } from '../../common/enums/platform.enum';

/**
 * üéÆ GAME HANDLERS
 * 
 * Standalone handlers for gamification system
 * Can be imported into ConversationService
 */
export class GameHandlers {
  private readonly logger = new Logger(GameHandlers.name);

  constructor(
    private sessionService: SessionService,
    private messagingService: MessagingService,
    private gameWidgetService: GameWidgetService,
  ) {}

  /**
   * Check if message is a game trigger
   */
  isGameTrigger(messageText: string): boolean {
    const lowerText = messageText.toLowerCase().trim();
    const gameKeywords = [
      'play', 'game', 'earn', 'money', 'reward', 'points', 
      'paise', 'kamao', 'khelo', 'gaming', 'prize'
    ];
    return gameKeywords.some(keyword => lowerText.includes(keyword));
  }

  /**
   * Activate game menu
   */
  async activateGames(phoneNumber: string, session: any): Promise<void> {
    try {
      // Get user ID from session (or create placeholder)
      const userId = session?.data?.user_info?.id || parseInt(phoneNumber.replace(/\D/g, '').slice(-8));
      
      this.logger.log(`üéÆ Activating games for user ${userId} (${phoneNumber})`);
      
      // Generate game widget
      const gameWidget = await this.gameWidgetService.generateGameWidget(userId);
      
      // Send game menu based on widget type
      if (gameWidget.type === 'list' && gameWidget.sections) {
        // WhatsApp interactive list
        await this.messagingService.sendListMessage(
          Platform.WHATSAPP,
          phoneNumber,
          gameWidget.header || 'üéÆ Play & Earn',
          gameWidget.body || 'Choose a game to play and earn rewards!',
          'Select Game',
          gameWidget.sections
        );
        
        // Set session step for game handling
        await this.sessionService.setStep(phoneNumber, 'game_menu');
        await this.sessionService.setData(phoneNumber, 'game_context', {
          activated_at: Date.now(),
          user_id: userId
        });
        
      } else if (gameWidget.type === 'buttons' && gameWidget.buttons) {
        // Button-based widget (resume game)
        await this.messagingService.sendButtonMessage(
          Platform.WHATSAPP,
          phoneNumber,
          gameWidget.body,
          gameWidget.buttons
        );
        await this.sessionService.setStep(phoneNumber, 'game_playing');
        
      } else {
        // Fallback: Simple text message
        await this.messagingService.sendTextMessage(
          Platform.WHATSAPP,
          phoneNumber,
          'üéÆ **Play & Earn Real Money!**\n\n' +
          'Available games:\n\n' +
          '1Ô∏è‚É£ **Intent Quest** (‚Çπ15 + 150pts)\n' +
          '   Help train AI by creating natural messages\n\n' +
          '2Ô∏è‚É£ **Language Master** (‚Çπ15 + 150pts)\n' +
          '   Mix Hindi & English naturally\n\n' +
          '3Ô∏è‚É£ **Tone Detective** (‚Çπ15 + 150pts)\n' +
          '   Express different emotions\n\n' +
          '4Ô∏è‚É£ **Quick Validations** (‚Çπ5 each)\n' +
          '   Yes/No questions\n\n' +
          '5Ô∏è‚É£ **Complete Profile** (‚Çπ1 per answer)\n' +
          '   Build your preferences\n\n' +
          'Reply with the game number (1-5) to start!'
        );
        await this.sessionService.setStep(phoneNumber, 'game_menu');
      }
      
      this.logger.log(`‚úÖ Game menu sent to ${phoneNumber}`);
      
    } catch (error) {
      this.logger.error(`‚ùå Game activation failed: ${error.message}`, error.stack);
      throw error; // Let caller handle fallback
    }
  }

  /**
   * Handle game menu selection
   */
  async handleGameMenu(phoneNumber: string, messageText: string): Promise<void> {
    const session = await this.sessionService.getSession(phoneNumber);
    const userId = session?.data?.user_info?.id || parseInt(phoneNumber.replace(/\D/g, '').slice(-8));
    
    // Handle game selection
    const selection = messageText.trim().toLowerCase();
    
    // Map user input to game IDs
    const gameMap: Record<string, string> = {
      '1': 'game_intent_quest',
      '2': 'game_language_master',
      '3': 'game_tone_detective',
      '4': 'game_validate_stores',
      '5': 'game_profile_builder',
      'intent quest': 'game_intent_quest',
      'language master': 'game_language_master',
      'tone detective': 'game_tone_detective',
      'validation': 'game_validate_stores',
      'profile': 'game_profile_builder'
    };
    
    const gameId = gameMap[selection];
    
    if (!gameId) {
      await this.messagingService.sendTextMessage(
        Platform.WHATSAPP,
        phoneNumber,
        '‚ùå Invalid selection. Please reply with 1-5 or type "menu" to go back.'
      );
      return;
    }
    
    // Handle game selection via GameWidgetService
    const result = await this.gameWidgetService.handleGameSelection(
      userId,
      gameId,
      this.messagingService,
      phoneNumber
    );
    
    if (result.success) {
      // Set session to game playing mode
      await this.sessionService.setStep(phoneNumber, 'game_playing');
      await this.sessionService.setData(phoneNumber, 'active_game', {
        game_id: gameId,
        started_at: Date.now(),
        mission: result.mission
      });
      
      this.logger.log(`üéÆ Game started: ${gameId} for user ${userId}`);
    }
  }

  /**
   * Handle game playing (process user response)
   */
  async handleGamePlaying(phoneNumber: string, messageText: string): Promise<void> {
    const session = await this.sessionService.getSession(phoneNumber);
    const userId = session?.data?.user_info?.id || parseInt(phoneNumber.replace(/\D/g, '').slice(-8));
    const activeGame = session?.data?.active_game;
    
    if (!activeGame) {
      this.logger.warn(`No active game for ${phoneNumber}`);
      await this.messagingService.sendTextMessage(
        Platform.WHATSAPP,
        phoneNumber,
        '‚ùå No active game session. Type "play game" to start!'
      );
      await this.sessionService.setStep(phoneNumber, 'main_menu');
      return;
    }
    
    // Process game response
    const result = await this.gameWidgetService.processGameResponse(
      userId,
      messageText,
      activeGame.game_id
    );
    
    if (result.success) {
      // Send feedback with score and rewards
      await this.messagingService.sendTextMessage(
        Platform.WHATSAPP,
        phoneNumber,
        `${result.feedback}\n\n` +
        `üí∞ **Earned:** ‚Çπ${result.rewards.wallet}\n` +
        `‚≠ê **Points:** ${result.rewards.points}\n` +
        `üìä **Score:** ${result.score}/100\n\n` +
        `Want to play again? Reply:\n` +
        `1Ô∏è‚É£ Same game\n` +
        `2Ô∏è‚É£ Different game\n` +
        `3Ô∏è‚É£ Back to menu`
      );
      
      // Clear active game
      await this.sessionService.setData(phoneNumber, 'active_game', null);
      await this.sessionService.setStep(phoneNumber, 'game_completion');
      
      // Log rewards earned
      this.logger.log(
        `üí∞ User ${userId} earned ‚Çπ${result.rewards.wallet} + ${result.rewards.points}pts ` +
        `from game (score: ${result.score}/100)`
      );
    }
  }

  /**
   * Handle game completion choice
   */
  async handleGameCompletion(phoneNumber: string, messageText: string): Promise<void> {
    const choice = messageText.trim();
    
    if (choice === '1') {
      // Play same game again
      const session = await this.sessionService.getSession(phoneNumber);
      const lastGame = session?.data?.active_game?.game_id;
      if (lastGame) {
        await this.sessionService.setStep(phoneNumber, 'game_menu');
        await this.handleGameMenu(phoneNumber, lastGame);
      }
    } else if (choice === '2') {
      // Show game menu
      const session = await this.sessionService.getSession(phoneNumber);
      await this.activateGames(phoneNumber, session);
    } else {
      // Back to main menu
      await this.sessionService.setStep(phoneNumber, 'main_menu');
      // Caller should call showMainMenu()
    }
  }
}
