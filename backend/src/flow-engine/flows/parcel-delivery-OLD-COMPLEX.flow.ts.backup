import { FlowDefinition } from '../types/flow.types';

export const parcelDeliveryFlow: FlowDefinition = {
  id: 'parcel_delivery_v1',
  name: 'Coolie / Local Delivery Flow',
  description: 'Complete local delivery (Coolie) booking flow with pickup, delivery, pricing and order placement',
  module: 'parcel',
  trigger: 'parcel_booking',
  version: '1.0.0',
  
  contextSchema: {
    pickup_address: { type: 'object', required: true },
    delivery_address: { type: 'object', required: true },
    distance: { type: 'number', required: true },
    pricing: { type: 'object', required: true },
    order_result: { type: 'object', required: false },
    parcel_details: { type: 'object', required: false },
  },
  
  states: {
    // First: Extract all info from the initial message using LLM
    extract_initial_info: {
      type: 'action',
      description: 'Extract pickup, delivery, and recipient info from user message',
      actions: [
        {
          id: 'smart_extract',
          executor: 'llm',
          config: {
            skipHistory: true,
            outputFormat: 'json',
            parseJson: true,
            systemPrompt: `You extract parcel booking details from user messages. Extract EVERYTHING the user mentions.
Return JSON with these fields (leave empty string if not found):
{
  "pickup_location": "Google Maps URL, coordinates, address text, OR saved address reference",
  "pickup_name": "Name of pickup contact person",
  "pickup_phone": "Full phone number exactly as given by user",
  "delivery_location": "Google Maps URL, coordinates, address text, OR saved address reference", 
  "delivery_name": "Name of recipient/delivery contact",
  "delivery_phone": "Full phone number exactly as given by user",
  "parcel_description": "What is being sent",
  "vehicle_preference": "bike, auto, car, truck, etc. if mentioned"
}

IMPORTANT RULES:
1. Saved address references: "my home", "home", "ghar", "office", "dukaan", "shop", "mera ghar", "42 wala address", "42 wala", "college wala", any "X wala" pattern = saved address reference
2. Phone numbers: Keep EXACTLY as user types (could be 10, 11, or 12 digits). Do NOT truncate or modify.
3. "from my friend X" means X is the pickup contact, NOT delivery contact
4. "pickup from my friend suresh" ‚Üí pickup_name:"suresh", pickup_location from context
5. "deliver to suresh" or "suresh ko bhejo" ‚Üí delivery_name:"suresh"
6. Vehicle: "bike is ok/fine", "bike se", "auto chahiye" = vehicle_preference

Examples:
- "pickup from my friend suresh 99233838121 from my home 42 wala address bike is ok" ‚Üí pickup_location:"42 wala", pickup_name:"suresh", pickup_phone:"99233838121", vehicle_preference:"bike"
- "pick up from my home" ‚Üí pickup_location:"home"
- "ghar se uthao" ‚Üí pickup_location:"home"  
- "office se pick karo" ‚Üí pickup_location:"office"
- "42 wala address se pickup" ‚Üí pickup_location:"42 wala"
- "https://maps.app.goo.gl/xyz drop to ramu 9987653422" ‚Üí delivery_location:"https://maps.app.goo.gl/xyz", delivery_name:"ramu", delivery_phone:"9987653422"`,
            prompt: `Extract parcel details from: "{{message}}"`,
            temperature: 0.1,
          },
          output: 'extracted_parcel_info',
        },
      ],
      transitions: {
        success: 'process_extracted_info',
        error: 'init',
      },
    },

    // Process extracted info and decide what to ask
    process_extracted_info: {
      type: 'decision',
      description: 'Check what info we have and route accordingly',
      conditions: [
        {
          expression: 'context.extracted_parcel_info?.pickup_location && context.extracted_parcel_info?.delivery_location',
          event: 'has_both_locations',
        },
        {
          expression: 'context.extracted_parcel_info?.pickup_location',
          event: 'has_pickup',
        },
        {
          expression: 'context.extracted_parcel_info?.delivery_location',
          event: 'has_delivery_only',
        },
      ],
      transitions: {
        has_both_locations: 'process_both_addresses',
        has_pickup: 'process_extracted_pickup',
        has_delivery_only: 'ask_pickup_first',
        default: 'collect_pickup',  // Go to collect_pickup which will offer saved addresses
      },
    },
    
    // Process extracted pickup address (from LLM extraction)
    process_extracted_pickup: {
      type: 'action',
      description: 'Process pickup address from LLM extracted info',
      actions: [
        {
          id: 'process_extracted_pickup',
          executor: 'address',
          config: {
            field: 'pickup_address',
            userMessage: '{{extracted_parcel_info.pickup_location}}',
          },
          output: 'pickup_address',
        },
      ],
      transitions: {
        address_valid: 'validate_pickup_zone',
        waiting_for_input: 'collect_pickup',
        error: 'collect_pickup',
      },
    },

    // Process both addresses when user gave both
    process_both_addresses: {
      type: 'action',
      description: 'Process both pickup and delivery from extracted info',
      actions: [
        {
          id: 'process_pickup_from_extract',
          executor: 'address',
          config: {
            field: 'pickup_address',
            userMessage: '{{extracted_parcel_info.pickup_location}}',
          },
          output: 'pickup_address',
        },
      ],
      transitions: {
        address_valid: 'process_delivery_from_extract',
        error: 'collect_pickup',
        waiting_for_input: 'collect_pickup',
      },
    },

    process_delivery_from_extract: {
      type: 'action',
      description: 'Process delivery address from extracted info',
      actions: [
        {
          id: 'process_delivery_from_extract',
          executor: 'address',
          config: {
            field: 'delivery_address',
            userMessage: '{{extracted_parcel_info.delivery_location}}',
          },
          output: 'delivery_address',
        },
      ],
      transitions: {
        address_valid: 'check_extracted_recipient',
        error: 'collect_delivery',
        waiting_for_input: 'collect_delivery',
      },
    },

    check_extracted_recipient: {
      type: 'decision',
      description: 'Check if recipient info was extracted',
      conditions: [
        {
          expression: 'context.extracted_parcel_info?.delivery_name && context.extracted_parcel_info?.delivery_phone',
          event: 'has_recipient',
        },
      ],
      transitions: {
        has_recipient: 'save_extracted_recipient',
        default: 'collect_recipient_details',
      },
    },

    save_extracted_recipient: {
      type: 'action',
      description: 'Save extracted recipient details',
      actions: [
        {
          id: 'save_recipient',
          executor: 'response',
          config: {
            message: '‚úÖ Got it! Sending to {{extracted_parcel_info.delivery_name}} ({{extracted_parcel_info.delivery_phone}})',
            setContext: {
              'recipient_details.name': '{{extracted_parcel_info.delivery_name}}',
              'recipient_details.phone': '{{extracted_parcel_info.delivery_phone}}',
            },
          },
          output: '_last_response',
        },
      ],
      transitions: {
        success: 'validate_pickup_zone',
        default: 'validate_pickup_zone',
      },
    },

    ask_pickup_first: {
      type: 'wait',
      description: 'User gave delivery but not pickup - ask for pickup',
      onEntry: [
        {
          id: 'ask_pickup_since_have_delivery',
          executor: 'response',
          config: {
            message: 'üìç Got the delivery location! Now where should I pick up the parcel from?\n\nShare pickup location or type address.',
          },
          output: '_last_response',
        },
      ],
      transitions: {
        user_message: 'process_pickup_address',
      },
    },

    // Check trigger
    check_trigger: {
      type: 'decision',
      description: 'Check if user already provided details',
      conditions: [
        {
          expression: 'context._user_message && context._user_message.length > 15',
          event: 'has_details',
        }
      ],
      transitions: {
        has_details: 'extract_initial_info',
        default: 'init',
      },
    },

    // Initial state - welcome and explain process
    init: {
      type: 'action',  // Use action to trigger address executor
      description: 'Welcome user and offer pickup address options',
      actions: [
        {
          id: 'offer_pickup_addresses',
          executor: 'address',
          config: {
            field: 'pickup_address',
            prompt: 'I can help you send items anywhere in Nashik. Where should I pick it up from?',
            offerSaved: true,
          },
          output: 'pickup_address',
        },
      ],
      transitions: {
        address_valid: 'validate_pickup_zone',
        waiting_for_input: 'wait_for_pickup',
        error: 'collect_pickup',
      },
    },
    
    // Wait for pickup input after showing options
    wait_for_pickup: {
      type: 'wait',
      description: 'Wait for user to select or provide pickup address',
      actions: [],
      transitions: {
        user_message: 'process_pickup_address',
      },
    },

    // Collect pickup address
    collect_pickup: {
      type: 'action',  // Action to offer addresses
      description: 'Collect pickup address with saved addresses support',
      actions: [
        {
          id: 'get_pickup_address',
          executor: 'address',
          config: {
            field: 'pickup_address',
            prompt: 'Where should we pick up the parcel from?',
            offerSaved: true,
          },
          output: 'pickup_address',
          retryOnError: true,
          maxRetries: 3,
        },
      ],
      transitions: {
        address_valid: 'validate_pickup_zone',
        waiting_for_input: 'wait_for_pickup',  // Go to wait state
        user_cancelled: 'cancelled',           // Handle cancel from address executor
        error: 'pickup_error',
      },
    },

    // Process pickup address from user
    process_pickup_address: {
      type: 'action',
      description: 'Process the pickup address provided by user',
      actions: [
        {
          id: 'extract_pickup',
          executor: 'address',
          config: {
            field: 'pickup_address',
            input: '{{_user_message}}',
          },
          output: 'pickup_address',
        },
      ],
      transitions: {
        address_valid: 'validate_pickup_zone',
        waiting_for_input: 'collect_pickup',
        error: 'pickup_error',
      },
    },

    // Validate pickup is in service zone
    validate_pickup_zone: {
      type: 'action',
      description: 'Check if pickup location is in Nashik service area',
      actions: [
        {
          id: 'check_pickup_zone',
          executor: 'zone',
          config: {
            latPath: 'pickup_address.latitude',
            lngPath: 'pickup_address.longitude',
          },
          output: 'pickup_zone',
        },
      ],
      transitions: {
        zone_valid: 'collect_delivery',
        zone_invalid: 'pickup_out_of_zone',
      },
    },

    // Collect delivery address
    collect_delivery: {
      type: 'action',
      description: 'Collect delivery address',
      actions: [
        {
          id: 'get_delivery_address',
          executor: 'address',
          config: {
            field: 'delivery_address',
            prompt: 'Where should we deliver the parcel?',
            offerSaved: true,
          },
          output: 'delivery_address',
          retryOnError: true,
          maxRetries: 3,
        },
      ],
      transitions: {
        address_valid: 'validate_delivery_zone',
        waiting_for_input: 'wait_for_delivery',
        user_cancelled: 'cancelled',           // Handle cancel from address executor
        error: 'delivery_error',
      },
    },

    // Wait for delivery input
    wait_for_delivery: {
      type: 'wait',
      description: 'Wait for user to provide delivery address',
      actions: [],
      transitions: {
        user_message: 'collect_delivery',
      },
    },

    // Validate delivery is in service zone
    validate_delivery_zone: {
      type: 'action',
      description: 'Check if delivery location is in service area',
      actions: [
        {
          id: 'check_delivery_zone',
          executor: 'zone',
          config: {
            latPath: 'delivery_address.latitude',
            lngPath: 'delivery_address.longitude',
          },
          output: 'delivery_zone',
        },
      ],
      transitions: {
        zone_valid: 'check_auth_for_recipient',
        zone_invalid: 'delivery_out_of_zone',
      },
    },

    // Check if user is authenticated before showing recipient options
    check_auth_for_recipient: {
      type: 'decision',
      description: 'Check if user is logged in to show appropriate recipient options',
      conditions: [
        {
          // User is authenticated (has phone number in context)
          expression: 'context.phone && context.phone !== "unknown"',
          event: 'authenticated',
        },
      ],
      transitions: {
        authenticated: 'collect_recipient_details_auth',
        default: 'collect_recipient_details_guest',
      },
    },

    // Collect recipient details for AUTHENTICATED users (with "Same as Sender" option)
    collect_recipient_details_auth: {
      type: 'wait',
      description: 'Ask for recipient - authenticated user can use Same as Sender',
      onEntry: [
        {
          id: 'ask_recipient_auth',
          executor: 'response',
          config: {
            message: 'üë§ Who should we deliver to?\n\nPlease provide:\n‚Ä¢ **Recipient Name**\n‚Ä¢ **Phone Number** (10 digits)\n\nOr tap "Same as Sender" if delivering to yourself:',
            buttons: [
              { label: 'üë§ Same as Sender', value: 'same_as_sender', action: 'same_as_sender' },
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_self_recipient',
        user_cancelled: 'cancelled',
      },
    },

    // Collect recipient details for GUEST users (NO "Same as Sender" option)
    collect_recipient_details_guest: {
      type: 'wait',
      description: 'Ask for recipient - guest must provide details',
      onEntry: [
        {
          id: 'ask_recipient_guest',
          executor: 'response',
          config: {
            message: 'üë§ Who should we deliver to?\n\nPlease provide:\n‚Ä¢ **Recipient Name**\n‚Ä¢ **Phone Number** (10 digits)\n\nExample: "Rahul 9876543210"',
            buttons: [
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'extract_recipient_details',  // Go directly to extraction for guests
        user_cancelled: 'cancelled',
      },
    },

    // Legacy state - redirect to appropriate state (for backward compatibility)
    collect_recipient_details: {
      type: 'decision',
      description: 'Redirect to appropriate recipient collection based on auth',
      conditions: [
        {
          expression: 'context.phone && context.phone !== "unknown"',
          event: 'authenticated',
        },
      ],
      transitions: {
        authenticated: 'collect_recipient_details_auth',
        default: 'collect_recipient_details_guest',
      },
    },

    // Check if user wants to use their own details (only reached by authenticated users now)
    check_self_recipient: {
      type: 'decision',
      description: 'Check if authenticated user wants to use their own details as recipient',
      conditions: [
        {
          // User clicked "Same as Sender" or typed me/myself/same/mera/khud
          expression: 'context._user_message?.toLowerCase().match(/^(same_as_sender|same|me|myself|mera|khud|mujhe|mai|main|apne|apna|sender|self)$/)',
          event: 'use_self',
        },
        {
          // User wants to cancel
          expression: 'context._user_message?.toLowerCase().match(/^(cancel|nahi|no|stop|exit|back|wapas)$/)',
          event: 'user_cancels',
        },
      ],
      transitions: {
        use_self: 'copy_sender_to_recipient',
        user_cancels: 'cancelled',
        default: 'extract_recipient_details', // Try to extract name/phone from message
      },
    },

    // Copy sender details to recipient
    copy_sender_to_recipient: {
      type: 'action',
      description: 'Use sender details as recipient',
      actions: [
        {
          id: 'copy_sender',
          executor: 'response',
          config: {
            message: '‚úÖ Got it! Delivering to yourself:\nüë§ **{{user_name}}**\nüì± **{{phone}}**',
            setContext: {
              'recipient_details.name': '{{user_name}}',
              'recipient_details.phone': '{{phone}}',
            },
          },
          output: '_last_response',
        },
      ],
      transitions: {
        default: 'collect_parcel_details',
      },
    },

    // Extract recipient details
    extract_recipient_details: {
      type: 'action',
      description: 'Extract recipient name and phone from user message',
      actions: [
        {
          id: 'extract_recipient',
          executor: 'llm',
          config: {
            systemPrompt: 'Extract recipient name and phone number from the message. Return JSON only.',
            prompt: 'User message: "{{_user_message}}"\n\nExtract recipient details as JSON:\n{"name": "Full Name", "phone": "phone number"}\n\nRules:\n- Keep phone number EXACTLY as typed (10 or 11 digits are valid)\n- Only remove +91 or 0 prefix if present\n- If only name given, phone is null\n- If only phone given, name is null\n- If unclear or invalid, return null for that field',
            temperature: 0.1,
            maxTokens: 100,
            parseJson: true,
          },
          output: 'recipient_details',
        },
      ],
      transitions: {
        success: 'check_recipient_validity',
        error: 'collect_recipient_details',
      },
    },

    // Check if recipient details are valid
    check_recipient_validity: {
      type: 'decision',
      description: 'Check if we got both name and phone',
      conditions: [
        {
          expression: 'context.recipient_details?.name && context.recipient_details?.phone',
          event: 'details_valid',
        },
      ],
      transitions: {
        details_valid: 'confirm_recipient',
        default: 'ask_missing_recipient_details', // Ask specifically for what's missing
      },
    },

    // Ask for missing recipient details
    ask_missing_recipient_details: {
      type: 'wait',
      description: 'Ask for specific missing details',
      onEntry: [
        {
          id: 'ask_missing',
          executor: 'response',
          config: {
            message: '‚ùì I need both **name** and **phone number** (10 digits).\n\nPlease provide: **Recipient Name** and **Phone Number**\n\nExample: "Rahul 9876543210"',
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_self_recipient', // Go back through the check
      },
    },

    // Confirm recipient details before proceeding
    confirm_recipient: {
      type: 'wait',
      description: 'Confirm extracted recipient details',
      onEntry: [
        {
          id: 'show_recipient',
          executor: 'response',
          config: {
            message: 'üë§ **Recipient Details:**\n‚Ä¢ Name: **{{recipient_details.name}}**\n‚Ä¢ Phone: **{{recipient_details.phone}}**\n\nIs this correct?',
            buttons: [
              { label: '‚úÖ Yes, Continue', value: 'yes', action: 'yes' },
              { label: '‚úèÔ∏è Change', value: 'change', action: 'change' },
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_recipient_confirmation',
      },
    },

    // Check recipient confirmation
    check_recipient_confirmation: {
      type: 'decision',
      description: 'Check if user confirmed recipient details',
      conditions: [
        {
          expression: 'context._user_message?.toLowerCase().match(/^(yes|ok|confirm|haan|ha|theek|correct|sahi)/)',
          event: 'confirmed',
        },
        {
          expression: 'context._user_message?.toLowerCase().match(/^(change|edit|no|nahi|galat|wrong)/)',
          event: 'change',
        },
        {
          expression: 'context._user_message?.toLowerCase().match(/^(cancel|stop|exit|back)/)',
          event: 'cancelled',
        },
      ],
      transitions: {
        confirmed: 'collect_parcel_details',
        change: 'collect_recipient_details',
        cancelled: 'cancelled',
        default: 'collect_parcel_details', // Assume yes if unclear
      },
    },

    // Collect parcel details (weight, size)
    collect_parcel_details: {
      type: 'wait',
      description: 'Ask for parcel weight and size',
      onEntry: [
        {
          id: 'ask_parcel_details',
          executor: 'response',
          config: {
            message: 'What are you sending? Please describe the item (e.g., "documents", "small box 2kg", "food packet"):\n\nOr just type "skip" to continue.',
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'extract_parcel_details',
      },
    },

    // Extract parcel details
    extract_parcel_details: {
      type: 'action',
      description: 'Extract parcel weight and size from user message',
      actions: [
        {
          id: 'extract_parcel',
          executor: 'llm',
          config: {
            systemPrompt: 'Extract parcel details from user message. Return JSON with weight (number) and size (small/medium/large) and description.',
            prompt: 'User message: {{_user_message}}\n\nExtract parcel details:\n{\n  "weight": 1,\n  "size": "small",\n  "description": "documents"\n}\nIf user says skip or unclear, use defaults: weight=1, size=small.',
            temperature: 0.1,
            maxTokens: 100,
            parseJson: true,
          },
          output: 'parcel_details',
        },
      ],
      transitions: {
        success: 'fetch_categories',
        default: 'fetch_categories',
      },
    },

    // Fetch vehicle categories
    fetch_categories: {
      type: 'action',
      description: 'Fetch available vehicle categories',
      actions: [
        {
          id: 'get_categories',
          executor: 'parcel',
          config: {
            action: 'get_categories',
            pickupAddressPath: 'pickup_address',
          },
          output: 'vehicle_categories',
        },
      ],
      transitions: {
        categories_fetched: 'show_categories',
        error: 'category_error',
      },
    },

    // Show categories and wait for selection
    show_categories: {
      type: 'wait',
      description: 'Show vehicle categories and wait for selection',
      onEntry: [
        {
          id: 'show_vehicle_cards',
          executor: 'response',
          config: {
            message: 'Please select a vehicle for your delivery:',
            cardsPath: 'vehicle_categories',
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'handle_vehicle_selection',
      },
    },

    // Handle vehicle selection
    handle_vehicle_selection: {
      type: 'action',
      description: 'Process vehicle selection',
      actions: [
        {
          id: 'interpret_vehicle_selection',
          executor: 'llm',
          config: {
            systemPrompt: 'You are a helper extracting the vehicle choice from user input. Return ONLY the category ID number.',
            prompt: `User said: "{{_user_message}}"
Available categories: {{json vehicle_categories}}

Which category ID did the user select?
- If user typed a number like "1", "2", "5", return that number if it exists in the category IDs
- If user typed a name like "bike", "scooter", "truck", return the matching category ID
- Return ONLY the ID number (e.g. 1, 5, 8, 9), nothing else
- If no match found, return "null"`,
            temperature: 0.1,
            maxTokens: 10,
            skipHistory: true, // Don't include conversation history for simple extraction
          },
          output: 'selected_category_id_raw',
        },
        {
          id: 'save_vehicle_selection',
          executor: 'response',
          config: {
             saveToContext: {
               'parcel_category_id': '{{selected_category_id_raw}}',
             }
          }
        }
      ],
      transitions: {
        success: 'validate_vehicle_selection',
      }
    },

    // Validate vehicle selection
    validate_vehicle_selection: {
      type: 'decision',
      description: 'Check if a valid vehicle was selected',
      conditions: [
        {
          expression: 'context.parcel_category_id && context.parcel_category_id !== "null"',
          event: 'valid_selection',
        }
      ],
      transitions: {
        valid_selection: 'calculate_distance',
        default: 'show_categories_retry',
      }
    },

    // Retry showing categories
    show_categories_retry: {
      type: 'wait',
      description: 'Show vehicle categories again with error message',
      actions: [
        {
          id: 'show_vehicle_cards_retry',
          executor: 'response',
          config: {
            message: 'I didn\'t catch that. Please select a vehicle from the list:',
            cardsPath: 'vehicle_categories',
          },
        },
      ],
      transitions: {
        user_message: 'handle_vehicle_selection',
      },
    },

    // Calculate distance between pickup and delivery
    calculate_distance: {
      type: 'action',
      description: 'Calculate distance using OSRM',
      actions: [
        {
          id: 'get_distance',
          executor: 'distance',
          config: {
            fromLatPath: 'pickup_address.latitude',
            fromLngPath: 'pickup_address.longitude',
            toLatPath: 'delivery_address.latitude',
            toLngPath: 'delivery_address.longitude',
          },
          output: 'distance',
          retryOnError: true,
          maxRetries: 2,
        },
      ],
      transitions: {
        calculated: 'calculate_pricing',
        error: 'distance_error',
      },
    },

    // Calculate pricing
    calculate_pricing: {
      type: 'action',
      description: 'Calculate parcel delivery pricing',
      actions: [
        {
          id: 'get_pricing',
          executor: 'parcel',
          config: {
            action: 'calculate_shipping',
            distancePath: 'distance',
            categoryPath: 'parcel_category_id',
          },
          output: 'pricing',
        },
      ],
      transitions: {
        shipping_calculated: 'show_summary',
        error: 'pricing_error',
      },
    },

    // Show order summary and ask for confirmation
    show_summary: {
      type: 'wait',
      description: 'Display order summary and request confirmation',
      onEntry: [
        {
          id: 'summary_message',
          executor: 'response',
          config: {
            message: `üì¶ **Order Summary**\n\nüìç **Pickup:** {{pickup_address.address}}\nüìç **Delivery:** {{delivery_address.address}}\nüë§ **Recipient:** {{recipient_details.name}} ({{recipient_details.phone}})\nüìè **Distance:** {{distance}} km\nüöó **Vehicle:** Bike Delivery\n\nüí∞ **Pricing:**\n- Delivery Charge: ‚Çπ{{pricing.delivery_charge}}\n- Platform Fee: ‚Çπ{{pricing.platform_fee}}\n- **Total: ‚Çπ{{pricing.total_charge}}**\n\nüí≥ **Payment:** Online Payment (Razorpay)\n\nPlease confirm or cancel your order:`,
            buttons: [
              { label: '‚úÖ Confirm Order', value: 'yes', action: 'yes' },
              { label: '‚ùå Cancel Order', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_confirmation',
      },
    },

    // Check if user confirmed
    check_confirmation: {
      type: 'decision',
      description: 'Evaluate user confirmation',
      conditions: [
        {
          // Support yes/confirm in English and Hindi
          expression: 'context._user_message?.toLowerCase().match(/^(yes|confirm|sure|ok|haan|ha|ji|proceed|theek|thik|book)/)',
          event: 'user_confirms',
        },
        {
          // Support no/cancel in English and Hindi
          expression: 'context._user_message?.toLowerCase().match(/^(no|cancel|nahi|nhi|nahin|ruk|rukho|stop|exit|quit|back|wapas)/)',
          event: 'user_cancels',
        },
      ],
      transitions: {
        user_confirms: 'check_auth_before_order',
        user_cancels: 'cancelled',
        default: 'show_summary_retry',
      },
    },

    // Check authentication before placing order
    check_auth_before_order: {
      type: 'decision',
      description: 'Verify user is logged in before placing order',
      conditions: [
        {
          // User has auth token (logged in)
          expression: 'context._system?.auth_token || context.data?.auth_token',
          event: 'authenticated',
        },
      ],
      transitions: {
        authenticated: 'place_order',
        default: 'require_login_for_order',
      },
    },

    // Require login before order
    require_login_for_order: {
      type: 'action',
      description: 'Ask user to login to place order',
      actions: [
        {
          id: 'require_login_message',
          executor: 'response',
          config: {
            message: `üîê **Login Required**\n\nTo place your order, please login or register.\nYour order details have been saved!\n\nüì¶ **Saved Order:**\nüìç From: {{pickup_address.address}}\nüìç To: {{delivery_address.address}}\nüí∞ Total: ‚Çπ{{pricing.total_charge}}`,
            buttons: [
              { label: 'üì± Login with Phone', value: 'login', action: 'login' },
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      transitions: {
        success: 'wait_for_login',
        default: 'wait_for_login',
      },
    },

    // Wait for user to login
    wait_for_login: {
      type: 'wait',
      description: 'Wait for user to login or cancel',
      onEntry: [],
      actions: [],
      transitions: {
        user_message: 'check_login_response',
        login_complete: 'place_order',
      },
    },

    // Check login response
    check_login_response: {
      type: 'decision',
      description: 'Check what user wants to do',
      conditions: [
        {
          expression: 'context._user_message?.toLowerCase().match(/^(cancel|nahi|no|exit|quit)/)',
          event: 'user_cancels',
        },
        {
          expression: 'context._user_message?.toLowerCase().match(/^(login|phone|otp|yes|ok)/)',
          event: 'wants_login',
        },
      ],
      transitions: {
        user_cancels: 'cancelled',
        wants_login: 'start_login_flow',
        default: 'require_login_for_order',
      },
    },

    // Start login flow
    start_login_flow: {
      type: 'action',
      description: 'Redirect to auth flow',
      actions: [
        {
          id: 'start_auth',
          executor: 'response',
          config: {
            message: 'üì± Please enter your mobile number to continue:',
            setContext: {
              'return_to_flow': 'parcel_delivery_v1',
              'return_to_state': 'place_order',
            },
          },
          output: '_last_response',
        },
      ],
      transitions: {
        success: 'collect_phone_for_login',
        default: 'collect_phone_for_login',
      },
    },

    // Collect phone for login
    collect_phone_for_login: {
      type: 'wait',
      description: 'Wait for phone number',
      onEntry: [],
      actions: [],
      transitions: {
        user_message: 'process_login_phone',
      },
    },

    // Process phone and trigger OTP
    process_login_phone: {
      type: 'action',
      description: 'Send OTP to phone',
      actions: [
        {
          id: 'send_otp',
          executor: 'auth',
          config: {
            action: 'send_otp',
            phoneField: '_user_message',
          },
          output: 'otp_result',
        },
      ],
      transitions: {
        success: 'wait_for_otp',
        error: 'login_error',
      },
    },

    // Wait for OTP
    wait_for_otp: {
      type: 'wait',
      description: 'Wait for OTP verification',
      onEntry: [
        {
          id: 'otp_prompt',
          executor: 'response',
          config: {
            message: '‚úÖ OTP sent! Please enter the 6-digit code:',
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'verify_otp',
      },
    },

    // Verify OTP
    verify_otp: {
      type: 'action',
      description: 'Verify OTP and login',
      actions: [
        {
          id: 'verify',
          executor: 'auth',
          config: {
            action: 'verify_otp',
            otpField: '_user_message',
          },
          output: 'auth_result',
        },
      ],
      transitions: {
        success: 'login_success',
        error: 'otp_error',
      },
    },

    // Login success - now place order
    login_success: {
      type: 'action',
      description: 'Login successful, proceed to order',
      actions: [
        {
          id: 'login_success_msg',
          executor: 'response',
          config: {
            message: '‚úÖ Login successful! Placing your order now...',
          },
          output: '_last_response',
        },
      ],
      transitions: {
        success: 'place_order',
        default: 'place_order',
      },
    },

    // Login error
    login_error: {
      type: 'wait',
      description: 'Login failed',
      onEntry: [
        {
          id: 'login_error_msg',
          executor: 'response',
          config: {
            message: '‚ùå Could not send OTP. Please check the phone number and try again:',
            buttons: [
              { label: 'üîÑ Try Again', value: 'retry', action: 'retry' },
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_login_retry',
      },
    },

    // Check login retry
    check_login_retry: {
      type: 'decision',
      conditions: [
        {
          expression: 'context._user_message?.toLowerCase().match(/^(cancel|no|nahi|exit)/)',
          event: 'user_cancels',
        },
      ],
      transitions: {
        user_cancels: 'cancelled',
        default: 'process_login_phone',
      },
    },

    // OTP error
    otp_error: {
      type: 'wait',
      description: 'OTP verification failed',
      onEntry: [
        {
          id: 'otp_error_msg',
          executor: 'response',
          config: {
            message: '‚ùå Invalid OTP. Please enter the correct 6-digit code:',
            buttons: [
              { label: 'üì± Resend OTP', value: 'resend', action: 'resend' },
              { label: '‚ùå Cancel', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_otp_retry',
      },
    },

    // Check OTP retry
    check_otp_retry: {
      type: 'decision',
      conditions: [
        {
          expression: 'context._user_message?.toLowerCase().match(/^(cancel|no|nahi|exit)/)',
          event: 'user_cancels',
        },
        {
          expression: 'context._user_message?.toLowerCase().match(/^(resend|again)/)',
          event: 'resend',
        },
      ],
      transitions: {
        user_cancels: 'cancelled',
        resend: 'process_login_phone',
        default: 'verify_otp',
      },
    },

    // Retry showing summary with clearer instructions
    show_summary_retry: {
      type: 'wait',
      description: 'Show summary again with clearer instructions',
      onEntry: [
        {
          id: 'retry_message',
          executor: 'response',
          config: {
            message: `I didn't understand that. Please tap one of the buttons below or type "yes" to confirm or "cancel" to cancel:\n\nüì¶ **Order Summary**\n\nüìç **Pickup:** {{pickup_address.address}}\nüìç **Delivery:** {{delivery_address.address}}\nüë§ **Recipient:** {{recipient_details.name}} ({{recipient_details.phone}})\nüí∞ **Total: ‚Çπ{{pricing.total_charge}}** (Delivery: ‚Çπ{{pricing.delivery_charge}} + Platform: ‚Çπ{{pricing.platform_fee}})\nüí≥ **Payment:** Online Payment`,
            buttons: [
              { label: '‚úÖ Confirm Order', value: 'yes', action: 'yes' },
              { label: '‚ùå Cancel Order', value: 'cancel', action: 'cancel' },
            ],
          },
          output: '_last_response',
        },
      ],
      actions: [],
      transitions: {
        user_message: 'check_confirmation_retry',
      },
    },

    // Second check - be more lenient
    check_confirmation_retry: {
      type: 'decision',
      description: 'Check confirmation again, more lenient',
      conditions: [
        {
          expression: 'context._user_message?.toLowerCase().match(/yes|confirm|ok|haan|ha|ji|proceed|book|1/)',
          event: 'user_confirms',
        },
        {
          expression: 'context._user_message?.toLowerCase().match(/no|cancel|nahi|stop|exit|back|2/)',
          event: 'user_cancels',
        },
      ],
      transitions: {
        user_confirms: 'check_auth_before_order',
        user_cancels: 'cancelled',
        default: 'forced_cancel',
      },
    },

    // Force cancel after too many failed attempts
    forced_cancel: {
      type: 'action',
      description: 'Cancel order after failed confirmations',
      actions: [
        {
          id: 'force_cancel_message',
          executor: 'response',
          config: {
            message: `‚ùå Order cancelled. You can start a new order anytime!\n\nHow can I help you?`,
            buttons: [
              { label: 'üì¶ Send Parcel', value: 'parcel', action: 'send_parcel' },
              { label: 'üçî Order Food', value: 'food', action: 'order_food' },
              { label: 'üõí Shop Online', value: 'shop', action: 'shop_online' },
              { label: '‚ùì Help', value: 'help', action: 'help' },
            ],
          },
          output: '_last_response',
        },
      ],
      transitions: {
        default: 'finish',
      },
    },

    // Place the order
    place_order: {
      type: 'action',
      description: 'Create parcel order in backend',
      actions: [
        {
          id: 'create_order',
          executor: 'order',
          config: {
            type: 'parcel',
            pickupAddressPath: 'pickup_address',
            deliveryAddressPath: 'delivery_address',
            recipientPath: 'recipient_details',
            distancePath: 'distance',
            pricingPath: 'pricing',
            detailsPath: 'parcel_details',
          },
          output: 'order_result',
          retryOnError: true,
          maxRetries: 2,
        },
      ],
      transitions: {
        success: 'completed',
        error: 'order_failed',
      },
    },

    // Success - order placed
    completed: {
      type: 'action',
      description: 'Order successfully placed',
      actions: [
        {
          id: 'success_message',
          executor: 'response',
          config: {
            message: `üéâ **Order Confirmed!**\n\nüì¶ Order ID: #{{order_result.orderId}}\nüìç From: {{pickup_address.address}}\nüìç To: {{delivery_address.address}}\nüí∞ Total: ‚Çπ{{pricing.total_charge}}\n‚è±Ô∏è Estimated: 30-45 minutes\n\nYou'll receive updates on WhatsApp. Track your order anytime!`,
            buttons: [
              { label: 'üìç Track Order', value: 'track_order', action: 'track_order' },
              { label: 'üè† Home', value: 'home', action: 'home' },
            ],
          },
          output: '_last_response',
        },
      ],
      transitions: {
        default: 'finish',
      },
    },

    finish: {
      type: 'end',
      description: 'Flow finished',
      actions: [],
      transitions: {},
    },

    // Error states
    pickup_error: {
      type: 'end',
      description: 'Failed to get valid pickup address',
      actions: [
        {
          id: 'error_message',
          executor: 'response',
          config: {
            message: 'Sorry, we couldn\'t understand your pickup address. Please try again later or contact support.',
          },
        },
      ],
      transitions: {},
    },

    delivery_error: {
      type: 'end',
      description: 'Failed to get valid delivery address',
      actions: [
        {
          id: 'error_message',
          executor: 'response',
          config: {
            message: 'Sorry, we couldn\'t understand your delivery address. Please try again later or contact support.',
          },
        },
      ],
      transitions: {},
    },

    pickup_out_of_zone: {
      type: 'end',
      description: 'Pickup location outside service area',
      actions: [
        {
          id: 'zone_error',
          executor: 'response',
          config: {
            message: 'Sorry, the pickup location is outside our current service area (Nashik). We\'ll let you know when we expand to your area!',
          },
        },
      ],
      transitions: {},
    },

    delivery_out_of_zone: {
      type: 'end',
      description: 'Delivery location outside service area',
      actions: [
        {
          id: 'zone_error',
          executor: 'response',
          config: {
            message: 'Sorry, the delivery location is outside our current service area (Nashik). We\'ll let you know when we expand to your area!',
          },
        },
      ],
      transitions: {},
    },

    distance_error: {
      type: 'end',
      description: 'Failed to calculate distance',
      actions: [
        {
          id: 'error_message',
          executor: 'response',
          config: {
            message: 'Sorry, we encountered an error calculating the distance. Please try again or contact support.',
          },
        },
      ],
      transitions: {},
    },

    category_error: {
      type: 'end',
      description: 'Failed to fetch categories',
      actions: [
        {
          id: 'error_message',
          executor: 'response',
          config: {
            message: 'Sorry, we couldn\'t fetch the available vehicles. Please try again later.',
          },
        },
      ],
      transitions: {},
    },

    pricing_error: {
      type: 'end',
      description: 'Failed to calculate pricing',
      actions: [
        {
          id: 'error_message',
          executor: 'response',
          config: {
            message: 'Sorry, we couldn\'t calculate the shipping charge. Please try again later.',
          },
        },
      ],
      transitions: {},
    },

    order_failed: {
      type: 'end',
      description: 'Order placement failed',
      actions: [
        {
          id: 'failure_message',
          executor: 'response',
          config: {
            message: 'Sorry, we couldn\'t place your order right now. Please try again in a few minutes or contact support.',
          },
        },
      ],
      transitions: {},
    },

    cancelled: {
      type: 'end',
      description: 'User cancelled the order',
      actions: [
        {
          id: 'cancel_message',
          executor: 'response',
          config: {
            message: '‚ùå No problem! Your order has been cancelled.\n\nHow can I help you?',
            buttons: [
              { label: 'üì¶ Send Parcel', value: 'parcel', action: 'send_parcel' },
              { label: 'üçî Order Food', value: 'food', action: 'order_food' },
              { label: 'üõí Shop Online', value: 'shop', action: 'shop_online' },
              { label: '‚ùì Help', value: 'help', action: 'help' },
            ],
          },
        },
      ],
      transitions: {},
    },
  },

  initialState: 'check_trigger',
  finalStates: ['finish', 'cancelled', 'pickup_error', 'delivery_error', 'pickup_out_of_zone', 'delivery_out_of_zone', 'distance_error', 'order_failed', 'category_error', 'pricing_error'],
};
