# Smart Order Flow - YAML Version
# Intelligent ordering system with fallback to parcel/pickup service
# Handles: Food orders, item pickup, parcel delivery with smart suggestions
# Supports: Mood-based, craving-based, discovery, repeat orders, and more

name: smart_order
version: "2.0"
description: Unified smart ordering with context-aware recommendations and parcel fallback

initial_state: analyze_request

context:
  # Request analysis
  requestType: null  # food_order, pickup, parcel, discovery, recommendation, repeat, unknown
  originalRequest: null
  intent: null       # urgent_hungry, quick_delivery, specific_craving, etc.
  intentConfidence: 0
  
  # Extracted entities
  foodType: null
  cuisine: null
  taste: []
  dietary: []
  maxBudget: null
  maxDeliveryTime: null
  timeOfDay: null
  occasion: null
  quantity: 1
  
  # Food order context
  restaurant: null
  restaurantFound: false
  items: []
  itemsFound: false
  
  # Recommendations
  recommendations: []
  selectedRecommendation: null
  
  # Parcel/pickup context
  pickupLocation: null
  pickupContact: null
  dropLocation: null
  dropContact: null
  parcelCategory: null  # food, documents, clothes, electronics, fragile, other
  parcelNotes: null
  
  # External search results
  externalRestaurantInfo: null
  phoneBookResults: []
  
  # User history
  lastOrder: null
  favorites: []
  orderHistory: []
  
  # Order details
  orderId: null
  orderType: null  # network_order, parcel_pickup, custom_parcel
  totalAmount: null

states:
  # ============================================
  # INITIAL REQUEST ANALYSIS
  # ============================================
  
  analyze_request:
    type: action
    on_entry:
      - action: set_context
        params:
          originalRequest: "{{input}}"
      - action: analyze_user_intent_smart
        params:
          input: "{{input}}"
          userId: "{{userId}}"
    transitions:
      # Urgency-based
      - event: urgent_hungry
        target: handle_urgent_hungry
      - event: quick_delivery
        target: handle_quick_delivery
      
      # Craving-based
      - event: specific_craving
        target: handle_specific_craving
      - event: cuisine_preference
        target: handle_cuisine_search
      - event: taste_preference
        target: handle_taste_search
      
      # Discovery-based
      - event: popular_nearby
        target: handle_popular_nearby
      - event: new_discovery
        target: handle_new_discovery
      - event: recommendation
        target: handle_smart_recommendation
      - event: surprise_me
        target: handle_surprise_me
      
      # Memory-based
      - event: repeat_order
        target: handle_repeat_order
      - event: previous_restaurant
        target: handle_previous_restaurant
      - event: favorite
        target: handle_favorites
      
      # Budget-based
      - event: budget_conscious
        target: handle_budget_search
      - event: value_seeking
        target: handle_deals_search
      
      # Context-based
      - event: time_based
        target: handle_time_based
      - event: occasion_based
        target: handle_occasion_based
      - event: health_based
        target: handle_health_search
      
      # Specific orders
      - event: food_order
        target: process_food_order
      - event: pickup_request
        target: process_pickup_request
      - event: parcel_request
        target: process_parcel_request
      
      # Fallback
      - event: unclear
        target: clarify_request

  # ============================================
  # URGENCY-BASED FLOWS
  # ============================================
  
  handle_urgent_hungry:
    type: action
    on_entry:
      - action: speak
        params:
          text: "I understand you're hungry! Let me find the fastest options for you üöÄ"
      - action: get_quick_delivery_options
        params:
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
          maxDeliveryTime: 30
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: fallback_popular

  handle_quick_delivery:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Looking for quick delivery! Here are the fastest options:"
      - action: get_quick_delivery_options
        params:
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
          maxDeliveryTime: 25
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: fallback_popular

  # ============================================
  # CRAVING-BASED FLOWS
  # ============================================
  
  handle_specific_craving:
    type: action
    on_entry:
      - action: speak
        params:
          text: "{{context.foodType}} craving? Let me find the best options! üçΩÔ∏è"
      - action: search_for_craving
        params:
          foodType: "{{context.foodType}}"
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: offer_parcel_alternative

  handle_cuisine_search:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Looking for {{context.cuisine}} cuisine! Here are the best options:"
      - action: search_by_cuisine
        params:
          cuisine: "{{context.cuisine}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: no_cuisine_found

  no_cuisine_found:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find {{context.cuisine}} restaurants nearby. Would you like to try a similar cuisine or should I search further?"
    transitions:
      - event: similar
        target: suggest_similar_cuisines
      - event: search_further
        target: search_external_cuisine
      - event: input_received
        target: analyze_request

  handle_taste_search:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Something {{context.taste}} coming up! üå∂Ô∏è"
      - action: search_by_taste
        params:
          taste: "{{context.taste}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: fallback_popular

  # ============================================
  # DISCOVERY-BASED FLOWS
  # ============================================
  
  handle_popular_nearby:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Here's what's trending in your area! ‚≠ê"
      - action: get_popular_nearby
        params:
          userLocation: "{{userLocation}}"
          sortBy: "popularity"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: clarify_request

  handle_new_discovery:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Love the adventurous spirit! Here are some places you haven't tried: ‚ú®"
      - action: get_new_recommendations
        params:
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: handle_popular_nearby

  handle_smart_recommendation:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Let me think of the perfect recommendation for you... ü§î"
      - action: get_smart_recommendations
        params:
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
          timeOfDay: "{{context.timeOfDay}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: handle_popular_nearby

  handle_surprise_me:
    type: action
    on_entry:
      - action: speak
        params:
          text: "I love surprises! Let me pick something special for you... üéÅ"
      - action: get_surprise_recommendation
        params:
          userId: "{{userId}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_single_recommendation
      - event: no_results
        target: handle_popular_nearby

  # ============================================
  # MEMORY-BASED FLOWS
  # ============================================
  
  handle_repeat_order:
    type: action
    on_entry:
      - action: get_last_order
        params:
          userId: "{{userId}}"
    transitions:
      - event: order_found
        target: confirm_repeat_order
      - event: no_order
        target: no_previous_order

  confirm_repeat_order:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Your last order was from **{{context.lastOrder.restaurant}}**: {{context.lastOrder.items}}. Shall I order the same? üîÑ"
    transitions:
      - event: yes
        target: place_repeat_order
      - event: no
        target: handle_smart_recommendation
      - event: modify
        target: modify_repeat_order

  place_repeat_order:
    type: action
    on_entry:
      - action: create_repeat_order
        params:
          orderId: "{{context.lastOrder.id}}"
          userId: "{{userId}}"
    transitions:
      - event: success
        target: order_success
      - event: failed
        target: order_failed

  modify_repeat_order:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What would you like to change from your last order?"
    transitions:
      - event: input_received
        target: process_order_modification

  no_previous_order:
    type: message
    on_entry:
      - action: speak
        params:
          text: "I don't see any previous orders. Let me help you find something great!"
    transitions:
      - event: next
        target: handle_smart_recommendation

  handle_previous_restaurant:
    type: action
    on_entry:
      - action: get_order_history
        params:
          userId: "{{userId}}"
          limit: 5
    transitions:
      - event: history_found
        target: show_recent_restaurants
      - event: no_history
        target: no_previous_order

  show_recent_restaurants:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Here are your recent restaurants:\n{{context.orderHistory}}\n\nWhich one would you like to order from?"
    transitions:
      - event: input_received
        target: select_from_history

  select_from_history:
    type: action
    on_entry:
      - action: match_restaurant_from_history
        params:
          input: "{{input}}"
          history: "{{context.orderHistory}}"
    transitions:
      - event: matched
        target: show_restaurant_menu
      - event: no_match
        target: handle_smart_recommendation

  handle_favorites:
    type: action
    on_entry:
      - action: get_user_favorites
        params:
          userId: "{{userId}}"
    transitions:
      - event: favorites_found
        target: show_favorites
      - event: no_favorites
        target: no_favorites_yet

  show_favorites:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Your favorite spots ‚ù§Ô∏è:\n{{context.favorites}}\n\nWhich one today?"
    transitions:
      - event: input_received
        target: select_from_favorites

  no_favorites_yet:
    type: message
    on_entry:
      - action: speak
        params:
          text: "You haven't saved any favorites yet. Let me recommend some places you might love!"
    transitions:
      - event: next
        target: handle_smart_recommendation

  # ============================================
  # BUDGET-BASED FLOWS
  # ============================================
  
  handle_budget_search:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Looking for budget-friendly options{{#context.maxBudget}} under ‚Çπ{{context.maxBudget}}{{/context.maxBudget}}! üí∞"
      - action: search_by_budget
        params:
          maxBudget: "{{context.maxBudget}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: no_budget_options

  no_budget_options:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find options under ‚Çπ{{context.maxBudget}}. Would you like to increase your budget or see the cheapest available options?"
    transitions:
      - event: increase
        target: ask_new_budget
      - event: cheapest
        target: show_cheapest_options
      - event: input_received
        target: analyze_request

  handle_deals_search:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Finding the best deals and offers for you! üéâ"
      - action: search_deals
        params:
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: no_deals_available

  no_deals_available:
    type: message
    on_entry:
      - action: speak
        params:
          text: "No special deals right now, but here are some great value options:"
    transitions:
      - event: next
        target: handle_budget_search

  # ============================================
  # CONTEXT-BASED FLOWS
  # ============================================
  
  handle_time_based:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Perfect {{context.timeOfDay}} options for you! üïê"
      - action: get_time_based_recommendations
        params:
          timeOfDay: "{{context.timeOfDay}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: fallback_popular

  handle_occasion_based:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Great for your {{context.occasion}}{{#context.quantity}} for {{context.quantity}} people{{/context.quantity}}! üéâ"
      - action: get_occasion_recommendations
        params:
          occasion: "{{context.occasion}}"
          quantity: "{{context.quantity}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: suggest_bulk_options

  handle_health_search:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Healthy choices coming up! ü•ó"
      - action: search_healthy_options
        params:
          dietary: "{{context.dietary}}"
          userLocation: "{{userLocation}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_results
        target: no_healthy_options

  no_healthy_options:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find specific {{context.dietary}} options nearby. Would you like to see restaurants with healthy menu items?"
    transitions:
      - event: yes
        target: search_general_healthy
      - event: no
        target: handle_smart_recommendation

  # ============================================
  # RECOMMENDATION PRESENTATION
  # ============================================
  
  present_recommendations:
    type: input
    on_entry:
      - action: format_recommendations
        params:
          recommendations: "{{context.recommendations}}"
      - action: speak
        params:
          text: "{{formatted_recommendations}}\n\nWhich one would you like? (Say the number or name)"
    transitions:
      - event: selection
        target: process_selection
      - event: more_options
        target: show_more_options
      - event: none_liked
        target: offer_alternatives
      - event: input_received
        target: parse_selection

  present_single_recommendation:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I picked **{{context.recommendations[0].name}}** for you! {{context.recommendations[0].reason}}\n\nShall I order from here? üéÅ"
    transitions:
      - event: yes
        target: show_restaurant_menu
      - event: no
        target: show_more_options
      - event: input_received
        target: parse_yes_no

  parse_selection:
    type: action
    on_entry:
      - action: match_user_selection
        params:
          input: "{{input}}"
          recommendations: "{{context.recommendations}}"
    transitions:
      - event: matched
        target: process_selection
      - event: no_match
        target: selection_unclear
      - event: more
        target: show_more_options
      - event: none
        target: offer_alternatives

  process_selection:
    type: action
    on_entry:
      - action: set_context
        params:
          restaurant: "{{context.selectedRecommendation}}"
    transitions:
      - event: is_restaurant
        target: show_restaurant_menu
      - event: is_item
        target: add_item_to_cart

  selection_unclear:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I didn't quite catch that. Could you say the number (1, 2, 3) or the restaurant name?"
    transitions:
      - event: input_received
        target: parse_selection

  show_more_options:
    type: action
    on_entry:
      - action: get_more_recommendations
        params:
          offset: "{{context.recommendations.length}}"
          context: "{{context}}"
    transitions:
      - event: recommendations_ready
        target: present_recommendations
      - event: no_more
        target: no_more_options

  no_more_options:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Those are all the options I have. Would you like to try a different search or explore categories?"
    transitions:
      - event: different
        target: clarify_request
      - event: categories
        target: show_categories
      - event: input_received
        target: analyze_request

  offer_alternatives:
    type: input
    on_entry:
      - action: speak
        params:
          text: "No worries! Would you like to:\n1. Try a different cuisine\n2. See what's popular\n3. Tell me exactly what you're craving"
    transitions:
      - event: cuisine
        target: ask_cuisine
      - event: popular
        target: handle_popular_nearby
      - event: input_received
        target: analyze_request

  offer_parcel_alternative:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find {{context.foodType}} on our network, but I can search nearby and arrange a rider to pick it up for you. Should I search?"
    transitions:
      - event: yes
        target: search_external_for_parcel
      - event: no
        target: offer_alternatives

  fallback_popular:
    type: message
    on_entry:
      - action: speak
        params:
          text: "Let me show you what's popular instead:"
    transitions:
      - event: next
        target: handle_popular_nearby

  show_restaurant_menu:
    type: action
    on_entry:
      - action: get_restaurant_menu
        params:
          restaurantId: "{{context.restaurant.id}}"
      - action: speak
        params:
          text: "Here's the menu from **{{context.restaurant.name}}**:\n{{menu_summary}}\n\nWhat would you like to order?"
    transitions:
      - event: menu_loaded
        target: collect_items
      - event: menu_error
        target: menu_unavailable

  collect_items:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What would you like to add? (e.g., '2 butter chicken', '1 naan')"
    transitions:
      - event: input_received
        target: parse_items
      - event: done
        target: confirm_food_order

  parse_items:
    type: action
    on_entry:
      - action: extract_items_from_input
        params:
          input: "{{input}}"
          menu: "{{restaurant_menu}}"
    transitions:
      - event: items_found
        target: items_added
      - event: items_not_found
        target: suggest_similar_items
      - event: done
        target: confirm_food_order

  items_added:
    type: input
    on_entry:
      - action: add_to_cart
        params:
          items: "{{extracted_items}}"
      - action: speak
        params:
          text: "Added! Your cart: {{cart_summary}}\n\nAnything else, or shall I proceed to checkout?"
    transitions:
      - event: more
        target: collect_items
      - event: done
        target: confirm_food_order
      - event: input_received
        target: parse_more_or_done

  # ============================================
  # LEARNING & FEEDBACK
  # ============================================
  
  collect_feedback:
    type: action
    on_entry:
      - action: track_user_choice
        params:
          userId: "{{userId}}"
          intent: "{{context.intent}}"
          selectedOption: "{{context.selectedRecommendation}}"
          recommendations: "{{context.recommendations}}"
          timestamp: "{{now}}"
    transitions:
      - event: tracked
        target: continue_order

  clarify_request:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I'd like to help you! What are you in the mood for?\n\nüçï Something specific (pizza, biryani...)\nüöÄ Quick delivery\n‚≠ê Popular nearby\nüí∞ Budget-friendly\nüîÑ My usual order"
          text_swahili: "Ningependa kukusaidia! Je, unataka kuagiza chakula, kuchukua kitu, au kutuma kifurushi?"
    transitions:
      - event: food
        target: ask_food_details
      - event: pickup
        target: ask_pickup_details
      - event: parcel
        target: ask_parcel_details
      - event: input_received
        target: analyze_request

  # ============================================
  # FOOD ORDER FLOW WITH SMART FALLBACK
  # ============================================
  
  process_food_order:
    type: action
    on_entry:
      - action: extract_food_order_details
        params:
          input: "{{context.originalRequest}}"
      # Extracts: restaurant name, items, quantity, delivery location
    transitions:
      - event: extracted
        target: search_restaurant_network

  search_restaurant_network:
    type: action
    on_entry:
      - action: search_mangwale_network
        params:
          restaurantName: "{{extracted_restaurant}}"
          location: "{{user_location}}"
    transitions:
      - event: found
        target: search_items_in_restaurant
      - event: not_found
        target: restaurant_not_in_network
      - event: multiple_matches
        target: clarify_restaurant

  clarify_restaurant:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I found multiple restaurants matching '{{extracted_restaurant}}': {{restaurant_options}}. Which one did you mean?"
    transitions:
      - event: input_received
        target: select_restaurant

  select_restaurant:
    type: action
    on_entry:
      - action: match_restaurant_selection
        params:
          input: "{{input}}"
          options: "{{restaurant_matches}}"
    transitions:
      - event: selected
        target: search_items_in_restaurant
      - event: none_match
        target: restaurant_not_in_network

  search_items_in_restaurant:
    type: action
    on_entry:
      - action: search_menu_items
        params:
          restaurantId: "{{context.restaurant.id}}"
          items: "{{extracted_items}}"
    transitions:
      - event: all_found
        target: confirm_food_order
      - event: partial_found
        target: some_items_missing
      - event: none_found
        target: items_not_found

  confirm_food_order:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Great! I found everything. Your order from {{context.restaurant.name}}: {{order_summary}}. Total: {{context.totalAmount}}. Deliver to {{delivery_address}}. Confirm?"
    transitions:
      - event: yes
        target: place_network_order
      - event: no
        target: modify_order
      - event: change_address
        target: get_delivery_address

  some_items_missing:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I found {{found_items}} but couldn't find '{{missing_items}}' on the menu. Would you like to: 1) Order what's available, 2) See similar items, or 3) Have our rider pick up directly from the restaurant?"
    transitions:
      - event: available
        target: confirm_food_order
      - event: similar
        target: show_similar_items
      - event: pickup
        target: convert_to_parcel_pickup

  show_similar_items:
    type: input
    on_entry:
      - action: get_similar_items
        params:
          restaurantId: "{{context.restaurant.id}}"
          query: "{{missing_items}}"
      - action: speak
        params:
          text: "Here are similar items: {{similar_items}}. Would you like to add any of these?"
    transitions:
      - event: input_received
        target: add_similar_items

  add_similar_items:
    type: action
    on_entry:
      - action: add_to_cart
        params:
          items: "{{input}}"
    transitions:
      - event: added
        target: confirm_food_order
      - event: skip
        target: confirm_food_order

  # ============================================
  # RESTAURANT NOT IN NETWORK - SMART FALLBACK
  # ============================================
  
  restaurant_not_in_network:
    type: action
    on_entry:
      - action: speak
        params:
          text: "I couldn't find '{{extracted_restaurant}}' in our restaurant network. But don't worry, I have options for you!"
      - action: search_external_restaurant
        params:
          name: "{{extracted_restaurant}}"
          location: "{{user_location}}"
    transitions:
      - event: found_external
        target: offer_parcel_pickup_option
      - event: not_found_external
        target: offer_alternatives

  offer_parcel_pickup_option:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I found {{context.externalRestaurantInfo.name}} at {{context.externalRestaurantInfo.address}} ({{context.externalRestaurantInfo.distance}} away). It's not on our network, but I can: 1) Send a rider to pick up your order for you, or 2) Show you similar restaurants on our network. What would you prefer?"
          text_swahili: "Nimepata {{context.externalRestaurantInfo.name}} huko {{context.externalRestaurantInfo.address}}. Haipo kwenye mtandao wetu, lakini ninaweza: 1) Kutuma mpanda pikipiki kuchukua oda yako, au 2) Kukuonyesha migahawa inayofanana kwenye mtandao wetu."
    transitions:
      - event: pickup
        target: setup_restaurant_parcel_pickup
      - event: alternatives
        target: show_network_alternatives
      - event: input_received
        target: parse_fallback_choice

  parse_fallback_choice:
    type: action
    on_entry:
      - action: classify_user_choice
        params:
          input: "{{input}}"
    transitions:
      - event: wants_pickup
        target: setup_restaurant_parcel_pickup
      - event: wants_alternatives
        target: show_network_alternatives
      - event: unclear
        target: offer_parcel_pickup_option

  setup_restaurant_parcel_pickup:
    type: message
    on_entry:
      - action: set_context
        params:
          orderType: "parcel_pickup"
          pickupLocation: "{{context.externalRestaurantInfo.address}}"
          parcelCategory: "food"
      - action: speak
        params:
          text: "Perfect! Here's how it works: You call {{context.externalRestaurantInfo.name}} at {{context.externalRestaurantInfo.phone}} to place your order. Our rider will pick it up and deliver to you. Let me get the details."
    transitions:
      - event: next
        target: get_parcel_order_notes

  get_parcel_order_notes:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What items do you want the rider to pick up? (e.g., '1 plate missal, 2 vada pav'). The rider will confirm this with the restaurant."
    transitions:
      - event: input_received
        target: confirm_pickup_order

  confirm_pickup_order:
    type: input
    on_entry:
      - action: set_context
        params:
          parcelNotes: "{{input}}"
      - action: calculate_parcel_fee
        params:
          pickupLocation: "{{context.pickupLocation}}"
          dropLocation: "{{user_address}}"
          category: "food"
      - action: speak
        params:
          text: "Got it! Order details: Pick up from {{context.externalRestaurantInfo.name}} - '{{context.parcelNotes}}'. Deliver to {{user_address}}. Rider fee: {{rider_fee}}. Note: You'll pay the restaurant directly. Confirm?"
    transitions:
      - event: yes
        target: place_parcel_order
      - event: no
        target: modify_parcel_order

  show_network_alternatives:
    type: input
    on_entry:
      - action: search_similar_restaurants
        params:
          cuisine: "{{extracted_cuisine}}"
          items: "{{extracted_items}}"
          location: "{{user_location}}"
      - action: speak
        params:
          text: "Here are similar restaurants on our network that serve {{extracted_cuisine}}: {{alternative_restaurants}}. Would you like to order from any of these?"
    transitions:
      - event: input_received
        target: select_alternative_restaurant
      - event: no
        target: offer_parcel_pickup_final

  select_alternative_restaurant:
    type: action
    on_entry:
      - action: match_restaurant_selection
        params:
          input: "{{input}}"
          options: "{{alternative_restaurants}}"
    transitions:
      - event: selected
        target: search_items_in_restaurant
      - event: none_selected
        target: offer_parcel_pickup_final

  offer_parcel_pickup_final:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Would you still like me to arrange a rider to pick up from {{extracted_restaurant}}? I can search online for their location and contact."
    transitions:
      - event: yes
        target: search_external_for_parcel
      - event: no
        target: end_no_order

  search_external_for_parcel:
    type: action
    on_entry:
      - action: search_external_restaurant
        params:
          name: "{{extracted_restaurant}}"
          location: "{{user_location}}"
    transitions:
      - event: found
        target: setup_restaurant_parcel_pickup
      - event: not_found
        target: manual_restaurant_entry

  manual_restaurant_entry:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find the restaurant online. Do you have their address or phone number?"
    transitions:
      - event: input_received
        target: parse_restaurant_info

  parse_restaurant_info:
    type: action
    on_entry:
      - action: extract_location_info
        params:
          input: "{{input}}"
    transitions:
      - event: address_found
        target: confirm_manual_pickup
      - event: phone_found
        target: confirm_manual_pickup
      - event: invalid
        target: request_restaurant_address

  request_restaurant_address:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Please provide the restaurant's address so our rider can pick up your order."
    transitions:
      - event: input_received
        target: validate_pickup_address

  validate_pickup_address:
    type: action
    on_entry:
      - action: geocode_address
        params:
          address: "{{input}}"
    transitions:
      - event: valid
        target: confirm_manual_pickup
      - event: invalid
        target: request_restaurant_address

  confirm_manual_pickup:
    type: message
    on_entry:
      - action: set_context
        params:
          pickupLocation: "{{validated_address}}"
          orderType: "parcel_pickup"
    transitions:
      - event: next
        target: get_parcel_order_notes

  items_not_found:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find '{{extracted_items}}' at {{context.restaurant.name}}. Would you like to: 1) See their full menu, 2) Try another restaurant, or 3) Have our rider pick up directly (you call ahead)?"
    transitions:
      - event: menu
        target: show_full_menu
      - event: another
        target: show_network_alternatives
      - event: pickup
        target: convert_to_parcel_pickup

  show_full_menu:
    type: input
    on_entry:
      - action: get_restaurant_menu
        params:
          restaurantId: "{{context.restaurant.id}}"
      - action: speak
        params:
          text: "Here's the menu for {{context.restaurant.name}}: {{menu_categories}}. What would you like to order?"
    transitions:
      - event: input_received
        target: process_menu_selection

  process_menu_selection:
    type: action
    on_entry:
      - action: parse_menu_selection
        params:
          input: "{{input}}"
          menu: "{{restaurant_menu}}"
    transitions:
      - event: items_found
        target: confirm_food_order
      - event: not_found
        target: items_not_found

  convert_to_parcel_pickup:
    type: message
    on_entry:
      - action: set_context
        params:
          orderType: "parcel_pickup"
          pickupLocation: "{{context.restaurant.address}}"
          parcelCategory: "food"
      - action: speak
        params:
          text: "I'll arrange for a rider to pick up from {{context.restaurant.name}}. Please call them at {{context.restaurant.phone}} to place your order."
    transitions:
      - event: next
        target: get_parcel_order_notes

  # ============================================
  # PICKUP REQUEST FLOW (Pick up from friend, etc.)
  # ============================================
  
  process_pickup_request:
    type: action
    on_entry:
      - action: extract_pickup_details
        params:
          input: "{{context.originalRequest}}"
      # Extracts: item, pickup person/location, drop location
    transitions:
      - event: extracted
        target: resolve_pickup_contact

  ask_pickup_details:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What do you need to pick up, and from where?"
    transitions:
      - event: input_received
        target: process_pickup_request

  resolve_pickup_contact:
    type: decision
    on_entry:
      - action: check_if_contact_name
        params:
          input: "{{extracted_pickup_from}}"
    transitions:
      - event: is_contact_name
        target: search_phone_book
      - event: is_address
        target: validate_pickup_location
      - event: unclear
        target: ask_pickup_location

  search_phone_book:
    type: action
    on_entry:
      - action: speak
        params:
          text: "Should I search for '{{extracted_contact_name}}' in your phone contacts?"
          text_swahili: "Je, nitafute '{{extracted_contact_name}}' katika anwani zako za simu?"
    transitions:
      - event: yes
        target: perform_contact_search
      - event: no
        target: ask_pickup_location

  perform_contact_search:
    type: action
    on_entry:
      - action: search_user_contacts
        params:
          query: "{{extracted_contact_name}}"
          userId: "{{userId}}"
    transitions:
      - event: found_single
        target: confirm_contact
      - event: found_multiple
        target: select_contact
      - event: not_found
        target: contact_not_found

  select_contact:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I found multiple contacts matching '{{extracted_contact_name}}': {{contact_options}}. Which one?"
    transitions:
      - event: input_received
        target: match_contact_selection

  match_contact_selection:
    type: action
    on_entry:
      - action: select_from_contacts
        params:
          input: "{{input}}"
          contacts: "{{context.phoneBookResults}}"
    transitions:
      - event: selected
        target: confirm_contact
      - event: none
        target: ask_pickup_location

  confirm_contact:
    type: input
    on_entry:
      - action: set_context
        params:
          pickupContact: "{{selected_contact}}"
      - action: speak
        params:
          text: "Pick up from {{context.pickupContact.name}} at {{context.pickupContact.address}}. Is this correct?"
    transitions:
      - event: yes
        target: check_drop_location
      - event: no
        target: ask_pickup_location

  contact_not_found:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find '{{extracted_contact_name}}' in your contacts. Please provide their address."
    transitions:
      - event: input_received
        target: validate_pickup_location

  ask_pickup_location:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Where should the rider pick up from? Please provide the address."
    transitions:
      - event: input_received
        target: validate_pickup_location

  validate_pickup_location:
    type: action
    on_entry:
      - action: geocode_address
        params:
          address: "{{input}}"
    transitions:
      - event: valid
        target: set_pickup_location
      - event: invalid
        target: invalid_pickup_address

  invalid_pickup_address:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find that address. Please provide a more specific location with landmarks."
    transitions:
      - event: input_received
        target: validate_pickup_location

  set_pickup_location:
    type: message
    on_entry:
      - action: set_context
        params:
          pickupLocation: "{{validated_address}}"
    transitions:
      - event: next
        target: check_drop_location

  check_drop_location:
    type: decision
    on_entry:
      - action: check_if_home_delivery
        params:
          originalRequest: "{{context.originalRequest}}"
    transitions:
      - event: deliver_home
        target: confirm_home_delivery
      - event: other_location
        target: ask_drop_location
      - event: not_specified
        target: ask_drop_location

  confirm_home_delivery:
    type: input
    on_entry:
      - action: get_user_home_address
        params:
          userId: "{{userId}}"
      - action: speak
        params:
          text: "Deliver to your home at {{user_home_address}}. Is this correct?"
    transitions:
      - event: yes
        target: set_drop_location_home
      - event: no
        target: ask_drop_location

  set_drop_location_home:
    type: message
    on_entry:
      - action: set_context
        params:
          dropLocation: "{{user_home_address}}"
    transitions:
      - event: next
        target: determine_parcel_category

  ask_drop_location:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Where should we deliver? Your home or another address?"
    transitions:
      - event: home
        target: confirm_home_delivery
      - event: input_received
        target: validate_drop_location

  validate_drop_location:
    type: action
    on_entry:
      - action: geocode_address
        params:
          address: "{{input}}"
    transitions:
      - event: valid
        target: set_drop_location
      - event: invalid
        target: invalid_drop_address

  invalid_drop_address:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find that address. Please provide a more specific delivery location."
    transitions:
      - event: input_received
        target: validate_drop_location

  set_drop_location:
    type: message
    on_entry:
      - action: set_context
        params:
          dropLocation: "{{validated_address}}"
    transitions:
      - event: next
        target: determine_parcel_category

  determine_parcel_category:
    type: action
    on_entry:
      - action: classify_parcel_category
        params:
          item: "{{extracted_item}}"
          context: "{{context.originalRequest}}"
    transitions:
      - event: food
        target: set_category_food
      - event: documents
        target: set_category_documents
      - event: clothes
        target: set_category_clothes
      - event: electronics
        target: confirm_fragile_handling
      - event: fragile
        target: confirm_fragile_handling
      - event: other
        target: ask_parcel_category

  set_category_food:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "food"
    transitions:
      - event: next
        target: get_pickup_notes

  set_category_documents:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "documents"
    transitions:
      - event: next
        target: get_pickup_notes

  set_category_clothes:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "clothes"
    transitions:
      - event: next
        target: get_pickup_notes

  confirm_fragile_handling:
    type: input
    on_entry:
      - action: speak
        params:
          text: "This seems like a fragile item. Should I add special handling instructions for the rider?"
    transitions:
      - event: yes
        target: set_fragile_category
      - event: no
        target: set_category_other

  set_fragile_category:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "fragile"
    transitions:
      - event: next
        target: get_pickup_notes

  set_category_other:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "other"
    transitions:
      - event: next
        target: get_pickup_notes

  ask_parcel_category:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What type of item is this? Food, documents, clothes, electronics, or other?"
    transitions:
      - event: food
        target: set_category_food
      - event: documents
        target: set_category_documents
      - event: clothes
        target: set_category_clothes
      - event: electronics
        target: confirm_fragile_handling
      - event: input_received
        target: parse_category

  parse_category:
    type: action
    on_entry:
      - action: classify_parcel_category
        params:
          input: "{{input}}"
    transitions:
      - event: classified
        target: set_parsed_category
      - event: unknown
        target: set_category_other

  set_parsed_category:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelCategory: "{{parsed_category}}"
    transitions:
      - event: next
        target: get_pickup_notes

  get_pickup_notes:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Any special instructions for the rider? (e.g., 'Ask for Suresh', 'Package is at reception', or say 'none')"
    transitions:
      - event: none
        target: calculate_and_confirm
      - event: input_received
        target: set_pickup_notes

  set_pickup_notes:
    type: message
    on_entry:
      - action: set_context
        params:
          parcelNotes: "{{input}}"
    transitions:
      - event: next
        target: calculate_and_confirm

  calculate_and_confirm:
    type: input
    on_entry:
      - action: calculate_parcel_fee
        params:
          pickup: "{{context.pickupLocation}}"
          drop: "{{context.dropLocation}}"
          category: "{{context.parcelCategory}}"
      - action: speak
        params:
          text: "Here's your parcel order:\nüì¶ Item: {{extracted_item}}\nüìç Pickup: {{context.pickupLocation}}\nüè† Drop: {{context.dropLocation}}\nüìù Notes: {{context.parcelNotes}}\nüí∞ Delivery fee: {{delivery_fee}}\n\nConfirm order?"
    transitions:
      - event: yes
        target: place_parcel_order
      - event: no
        target: modify_parcel_order

  modify_parcel_order:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What would you like to change? Pickup location, drop location, or instructions?"
    transitions:
      - event: pickup
        target: ask_pickup_location
      - event: drop
        target: ask_drop_location
      - event: instructions
        target: get_pickup_notes
      - event: cancel
        target: end_cancelled

  # ============================================
  # GENERAL PARCEL REQUEST
  # ============================================
  
  process_parcel_request:
    type: action
    on_entry:
      - action: extract_parcel_details
        params:
          input: "{{context.originalRequest}}"
    transitions:
      - event: extracted
        target: validate_pickup_location
      - event: incomplete
        target: ask_parcel_details

  ask_parcel_details:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What would you like to send, and from where to where?"
    transitions:
      - event: input_received
        target: process_parcel_request

  # ============================================
  # ORDER PLACEMENT
  # ============================================
  
  place_network_order:
    type: action
    on_entry:
      - action: create_food_order
        params:
          restaurant: "{{context.restaurant}}"
          items: "{{context.items}}"
          address: "{{delivery_address}}"
    transitions:
      - event: success
        target: order_success
      - event: failed
        target: order_failed

  place_parcel_order:
    type: action
    on_entry:
      - action: create_parcel_order
        params:
          pickupLocation: "{{context.pickupLocation}}"
          dropLocation: "{{context.dropLocation}}"
          category: "{{context.parcelCategory}}"
          notes: "{{context.parcelNotes}}"
          orderType: "{{context.orderType}}"
    transitions:
      - event: success
        target: parcel_order_success
      - event: failed
        target: order_failed

  order_success:
    type: end
    on_entry:
      - action: speak
        params:
          text: "üéâ Order placed successfully! Order #{{context.orderId}}. Your order from {{context.restaurant.name}} will arrive in {{estimated_time}}. You can track it anytime by saying 'track my order'."
          text_swahili: "üéâ Oda imewekwa! Nambari #{{context.orderId}}. Oda yako kutoka {{context.restaurant.name}} itafika kwa {{estimated_time}}."
      - action: send_confirmation_sms
      - action: emit
        params:
          event: order_placed
          data:
            orderId: "{{context.orderId}}"
            type: "network_order"

  parcel_order_success:
    type: end
    on_entry:
      - action: speak
        params:
          text: "üéâ Parcel pickup booked! Order #{{context.orderId}}. A rider will pick up from {{context.pickupLocation}} and deliver to {{context.dropLocation}}. Estimated time: {{estimated_time}}. Track anytime!"
          text_swahili: "üéâ Uchukuaji wa kifurushi umewekwa! Nambari #{{context.orderId}}. Mpanda pikipiki atachukua kutoka {{context.pickupLocation}} na kupeleka {{context.dropLocation}}."
      - action: send_confirmation_sms
      - action: emit
        params:
          event: parcel_booked
          data:
            orderId: "{{context.orderId}}"
            type: "{{context.orderType}}"

  order_failed:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Sorry, I couldn't place your order. Would you like to try again or speak to support?"
    transitions:
      - event: retry
        target: analyze_request
      - event: support
        target: escalate_to_support

  get_delivery_address:
    type: input
    on_entry:
      - action: speak
        params:
          text: "Where should we deliver?"
    transitions:
      - event: input_received
        target: validate_delivery_address

  validate_delivery_address:
    type: action
    on_entry:
      - action: geocode_address
        params:
          address: "{{input}}"
    transitions:
      - event: valid
        target: confirm_food_order
      - event: invalid
        target: invalid_delivery_address

  invalid_delivery_address:
    type: input
    on_entry:
      - action: speak
        params:
          text: "I couldn't find that address. Please be more specific."
    transitions:
      - event: input_received
        target: validate_delivery_address

  modify_order:
    type: input
    on_entry:
      - action: speak
        params:
          text: "What would you like to change? Items, restaurant, or delivery address?"
    transitions:
      - event: items
        target: show_full_menu
      - event: restaurant
        target: show_network_alternatives
      - event: address
        target: get_delivery_address
      - event: cancel
        target: end_cancelled

  escalate_to_support:
    type: action
    on_entry:
      - action: start_flow
        params:
          flow: complaints
    transitions:
      - event: complete
        target: end_support

  end_no_order:
    type: end
    on_entry:
      - action: speak
        params:
          text: "No problem! Let me know whenever you'd like to order something."

  end_cancelled:
    type: end
    on_entry:
      - action: speak
        params:
          text: "Order cancelled. Let me know if you need anything else!"

  end_support:
    type: end

# Actions definitions
actions:
  analyze_user_intent:
    description: Classify if user wants food order, pickup, or parcel
    executor: nlu
    
  extract_food_order_details:
    description: Extract restaurant, items, quantities from natural language
    executor: nlu
    
  search_mangwale_network:
    description: Search for restaurant in Mangwale partner network
    executor: search
    
  search_external_restaurant:
    description: Search Google/Maps for restaurant not in network
    executor: external_search
    
  search_user_contacts:
    description: Search user's phone book (requires permission)
    executor: contacts
    
  calculate_parcel_fee:
    description: Calculate delivery fee based on distance and category
    executor: pricing
