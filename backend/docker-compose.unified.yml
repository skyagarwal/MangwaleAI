
#############################################################################
# MANGWALE-AI UNIFIED STACK
# All AI services consolidated under single compose file
# Network: mangwale_unified_network
# Date: November 13, 2025
#############################################################################

networks:
  mangwale_unified:
    external: true
    name: mangwale_unified_network
  traefik_default:
    external: true
  search_network:
    external: true
    name: search_search-network

volumes:
  postgres_data:
    name: mangwale_postgres_data
  redis_data:
    name: mangwale_redis_data
  minio_data:
    name: mangwale_minio_data
  opensearch_data:
    name: mangwale_opensearch_data
  mysql_data:
    name: mangwale_mysql_data
  clickhouse_data:
    name: mangwale_clickhouse_data
  labelstudio_data:
    name: mangwale_labelstudio_data
  tts_cache:
    name: mangwale_tts_cache

services:
  #############################################################################
  # CORE INFRASTRUCTURE
  #############################################################################

  postgres:
    image: postgres:16-alpine
    container_name: mangwale_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=mangwale_config
      - POSTGRES_PASSWORD=config_secure_pass_2024
      - POSTGRES_DB=headless_mangwale
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./prisma/initial.sql:/docker-entrypoint-initdb.d/initial.sql
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mangwale_config -d headless_mangwale"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.2-alpine
    container_name: mangwale_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

  minio:
    image: minio/minio:latest
    container_name: mangwale_minio
    restart: unless-stopped
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    volumes:
      - minio_data:/data
    networks:
      - mangwale_unified
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  #############################################################################
  # AI SERVICES
  #############################################################################

  # Local LLM (vLLM with Qwen 7B)
  vllm:
    image: vllm/vllm-openai:v0.4.2
    container_name: mangwale_vllm
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "8002:8002"
    environment:
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ./models:/root/.cache/huggingface
    networks:
      - mangwale_unified
    command: >
      --model Qwen/Qwen2.5-7B-Instruct-AWQ
      --port 8002
      --host 0.0.0.0
      --max-model-len 4096
      --tensor-parallel-size 1
      --gpu-memory-utilization 0.85
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # NLU Service (IndicBERT)
  nlu:
    image: admin-nlu:latest
    container_name: mangwale_nlu
    restart: unless-stopped
    ports:
      - "7010:7010"
    volumes:
      - ./models:/srv/mangwale/models
      - ./training:/srv/mangwale/training
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:7010/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ASR Service (Whisper)
  asr:
    image: admin-asr-proxy:latest
    container_name: mangwale_asr
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "7000:8000"
    environment:
      - MODEL_SIZE=base
      - DEVICE=cuda
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # TTS Service (XTTS)
  tts:
    image: admin-xtts:latest
    container_name: mangwale_tts
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "8010:5501"
    volumes:
      - ./models/xtts:/app/models
      - tts_cache:/root/.local/share/tts
    environment:
      - COQUI_TOS_AGREED=1
      - XTTS_DEVICE=cpu
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:5501/health', timeout=5)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  #############################################################################
  # SEARCH INFRASTRUCTURE
  #############################################################################

  # Search services are external
  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: mangwale_opensearch
    restart: unless-stopped
    ports:
      - "9201:9200"
      - "9601:9600"
    environment:
      - cluster.name=mangwale-cluster
      - node.name=opensearch-node1
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.13.0
    container_name: mangwale_opensearch_dashboards
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    networks:
      - mangwale_unified
    depends_on:
      - opensearch

  embedding-service:
    build:
      context: ./docker/embedding
      dockerfile: Dockerfile
    image: mangwale_embedding_service:latest
    container_name: mangwale_embedding
    restart: unless-stopped
    ports:
      - "3102:3101"
    environment:
      - MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
      - DEVICE=cpu
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3101/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # search-api:
  #   image: search_search-api:latest
  #   container_name: mangwale_search_api
  #   restart: unless-stopped
  #   ports:
  #     - "3103:3100"
  #   environment:
  #     - OPENSEARCH_URL=http://opensearch:9200
  #     - EMBEDDING_SERVICE_URL=http://embedding-service:3101
  #     - REDIS_URL=redis://redis:6379
  #   networks:
  #     - mangwale_unified
  #   depends_on:
  #     - opensearch
  #     - redis
  #     - embedding-service
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  #############################################################################
  # VISION AI SERVICES
  #############################################################################

  # Vision will be integrated into mangwale-ai NestJS app as a module
  # No separate container needed - same codebase as Image AI
  
  # vision-api:
  #   (Vision functionality integrated in mangwale-ai service)

  #############################################################################
  # ANALYTICS & TRAINING
  #############################################################################

  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: mangwale_clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"  # HTTP
      - "9002:9000"  # Native (changed from 9000 to avoid MinIO conflict)
    environment:
      - CLICKHOUSE_DB=mangwale_analytics
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  labelstudio:
    image: heartexlabs/label-studio:1.21.0
    container_name: mangwale_labelstudio
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - DJANGO_DB=default
      - POSTGRE_NAME=headless_mangwale
      - POSTGRE_USER=mangwale_config
      - POSTGRE_PASSWORD=config_secure_pass_2024
      - POSTGRE_PORT=5432
      - POSTGRE_HOST=postgres
      # - LABEL_STUDIO_HOST=http://localhost:8080
    volumes:
      - labelstudio_data:/label-studio/data
      - ./label-studio-config.xml:/label-studio/config.xml
    networks:
      - mangwale_unified
    depends_on:
      - postgres

  #############################################################################
  # ROUTING & GATEWAY SERVICES
  #############################################################################

  # OSRM Backend (OpenStreetMap Routing)
  osrm-backend:
    build:
      context: ./docker
      dockerfile: osrm.Dockerfile
    container_name: mangwale_osrm
    restart: unless-stopped
    ports:
      - "5000:5000"
    volumes:
      - ./osrm-data:/data
    command: osrm-routed --algorithm mld /data/india-latest.osrm --max-table-size 10000
    networks:
      - mangwale_unified
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/nearest/v1/driving/77.5946,12.9716?number=1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # API Gateway (NestJS) - ENABLED for Chat App Auth
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: mangwale_api_gateway
    restart: unless-stopped
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=production
      - PORT=4001
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql://mangwale_config:config_secure_pass_2024@postgres:5432/headless_mangwale?schema=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SESSION_SECRET=change-this-secret-in-production
      - JWT_SECRET=change-this-jwt-secret
      - LOG_LEVEL=info
      # OSRM Configuration
      - OSRM_BASE_URL=http://osrm-backend:5000
      # Dispatcher API Configuration
      - DISPATCHER_API_URL=https://track.mangwale.in/api/v1/third-party
      - DISPATCHER_API_KEY=pk_test_xyz789abc012def345ghi678jkl901mno234pqr567stu890vwx123
      # Parcel Configuration
      - ALLOWED_PARCEL_CATEGORY_IDS=5,8,9
      # PHP Backend
      - PHP_BACKEND_URL=${PHP_BACKEND_URL}
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    depends_on:
      - postgres
      - redis
      - osrm-backend
    networks:
      - mangwale_unified
      - traefik_default
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_default
      # API Gateway HTTP routes
      - "traefik.http.routers.api-gateway.rule=Host(`chat.mangwale.ai`) && PathPrefix(`/api-gateway`)"
      - "traefik.http.routers.api-gateway.entrypoints=websecure"
      - "traefik.http.routers.api-gateway.tls=true"
      - "traefik.http.routers.api-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-gateway.priority=200"
      - "traefik.http.services.api-gateway.loadbalancer.server.port=4001"
      # Strip /api-gateway prefix before forwarding
      - "traefik.http.middlewares.api-gateway-stripprefix.stripprefix.prefixes=/api-gateway"
      - "traefik.http.routers.api-gateway.middlewares=api-gateway-stripprefix"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #############################################################################
  # MAIN APPLICATION
  #############################################################################

  mangwale-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mangwale_ai
    restart: unless-stopped
    ports:
      - "3200:3200"
    labels:
      - traefik.enable=true
      - traefik.docker.network=search_search-network
      - traefik.http.routers.ai-api.rule=Host(`api.mangwale.ai`)
      - traefik.http.routers.ai-api.entrypoints=websecure
      - traefik.http.routers.ai-api.tls=true
      - traefik.http.routers.ai-api.tls.certresolver=letsencrypt
      - traefik.http.routers.ai-api.service=mangwale-ai
      - traefik.http.routers.ai-websocket.rule=Host(`api.mangwale.ai`) && PathPrefix(`/socket.io`)
      - traefik.http.routers.ai-websocket.entrypoints=websecure
      - traefik.http.routers.ai-websocket.tls=true
      - traefik.http.routers.ai-websocket.tls.certresolver=letsencrypt
      - traefik.http.routers.ai-websocket.service=mangwale-ai
      - traefik.http.routers.ai-websocket.priority=100

      # admin.mangwale.ai - API routes (Direct routing, bypassing Next.js)
      - traefik.http.routers.ai-admin-api.rule=Host(`admin.mangwale.ai`) && PathPrefix(`/api`)
      - traefik.http.routers.ai-admin-api.entrypoints=websecure
      - traefik.http.routers.ai-admin-api.tls=true
      - traefik.http.routers.ai-admin-api.tls.certresolver=letsencrypt
      - traefik.http.routers.ai-admin-api.service=mangwale-ai
      - traefik.http.routers.ai-admin-api.priority=10

      # admin.mangwale.ai - WebSocket support (Direct routing)
      - traefik.http.routers.ai-admin-websocket.rule=Host(`admin.mangwale.ai`) && PathPrefix(`/socket.io`)
      - traefik.http.routers.ai-admin-websocket.entrypoints=websecure
      - traefik.http.routers.ai-admin-websocket.tls=true
      - traefik.http.routers.ai-admin-websocket.tls.certresolver=letsencrypt
      - traefik.http.routers.ai-admin-websocket.service=mangwale-ai
      - traefik.http.routers.ai-admin-websocket.priority=10

      - traefik.http.routers.ai-api-http.rule=Host(`api.mangwale.ai`)
      - traefik.http.routers.ai-api-http.entrypoints=web
      - traefik.http.routers.ai-api-http.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.services.mangwale-ai.loadbalancer.server.port=3200
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - PORT=3200
      - TZ=Asia/Kolkata
      
      # Database
      - DATABASE_URL=postgresql://mangwale_config:config_secure_pass_2024@postgres:5432/headless_mangwale
      
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      
      # AI Services (all local now!)
      - VLLM_URL=http://vllm:8002
      - NLU_ENDPOINT=http://nlu:7010
      - ASR_SERVICE_URL=http://asr:7000
      - TTS_SERVICE_URL=http://tts:8010
      - VISION_SERVICE_URL=http://localhost:3200/vision
      
      # Search
      - SEARCH_API_URL=http://search-api:3100
      - OPENSEARCH_URL=http://opensearch:9200
      - EMBEDDING_SERVICE_URL=http://embedding-service:3101
      
      # Storage
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin123
      
      # Analytics
      - CLICKHOUSE_URL=http://clickhouse:8123
      - LABEL_STUDIO_URL=http://labelstudio:8080
      - LABEL_STUDIO_API_KEY=28f1a27ec423ede7be5375852f70c20596940f78
      
      # Cloud LLM Fallbacks
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_CLOUD_PROVIDER=openrouter
      - ENABLED_LLM_PROVIDERS=groq,openrouter
      
      # WhatsApp
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      
      # PHP Backend (external)
      - PHP_API_BASE_URL=${PHP_API_BASE_URL}
      - PHP_DB_HOST=host.docker.internal
      - PHP_DB_PORT=23306
      - PHP_DB_USER=mangwale_user
      - PHP_DB_PASSWORD=admin123
      - PHP_DB_NAME=mangwale_db
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./training:/app/training
      - ./src/vision/models:/app/src/vision/models
    networks:
      - mangwale_unified
      - traefik_default
      - search_network
    depends_on:
      - postgres
      - redis
      - vllm
      - nlu
      - asr
      - tts
      # - search-api
      - opensearch
      - minio
      - clickhouse
      - labelstudio
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3200/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3

  #############################################################################
  # ADMIN TOOLS
  #############################################################################

  adminer:
    image: adminer:4
    container_name: mangwale_adminer
    restart: unless-stopped
    ports:
      - "8085:8080"
    networks:
      - mangwale_unified
    depends_on:
      - postgres
